<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G-Connect</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <style>
        :root {
            /* üåå COSMIC PALETTE - LIQUID GLASS V2 */
            --bg-deep: #000000;
            --bg-gradient: linear-gradient(135deg, #020617 0%, #0a1128 100%);

            /* üíé GLASS SURFACES */
            --glass-base: rgba(10, 15, 30, 0.65);
            /* Darker, more satin */
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.18);
            --glass-detail: rgba(255, 255, 255, 0.05);

            /* üåà ACCENTS */
            --primary: #2563eb;
            /* Vivid Blue */
            --primary-glow: rgba(37, 99, 235, 0.6);
            --secondary: #3b82f6;
            /* Lighter Blue */
            --accent-grad: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            /* Deep Blue Gradient */

            /* üé® TEXT */
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --text-dim: #64748b;

            /* üìê SHAPES */
            --radius-xl: 36px;
            --radius-lg: 28px;
            --radius-md: 18px;
            --radius-sm: 14px;

            /* üîÑ TRANSITIONS */
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: black;
            /* SAFETY BASE */
            background: linear-gradient(to bottom, #000000 0%, #0a1128 100%);
            /* ORDER THEME */
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            overflow: hidden;
            /* Main window overflow hidden */
            width: 100vw;
            height: 100dvh;
        }

        #app {
            height: 100%;
            overflow-y: scroll;
            overflow-x: hidden;
            /* CRITICAL MOBILE FIX */
            -webkit-overflow-scrolling: touch;
            padding-bottom: 140px;
            scroll-behavior: smooth;
            width: 100%;
            /* Ensure fits viewport */
            max-width: 100vw;
        }

        /* ‚ú® TYPOGRAPHY - ENTERED */
        h1,
        h2,
        h3 {
            text-align: center;
            /* ORDER */
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin: 0;
            color: white;
            /* Clean white */
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.01em;
            margin: 0;
            color: var(--text-main);
        }

        h3 {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            margin-bottom: 14px;
        }

        /* üíé CARDS (CLEAN WHITE SATIN - NO GLOW) */
        .card {
            background: rgba(255, 255, 255, 0.22);
            /* Homogeneous flat background */
            backdrop-filter: blur(30px) saturate(120%);
            -webkit-backdrop-filter: blur(30px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: none;
            /* REMOVED SHADOWS as requested */
            position: relative;
            overflow: hidden;
        }

        /* üíé PREMIUM SATIN PANEL */
        .glass-panel {
            background: rgba(255, 255, 255, 0.25);
            /* Flat homogeneous */
            backdrop-filter: blur(50px) saturate(100%);
            -webkit-backdrop-filter: blur(50px) saturate(100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: none;
            /* REMOVED GLOWS */
            border-radius: var(--radius-xl);
        }

        /* CALENDAR ROUNDING & COMPACTING */
        .fc-theme-standard td,
        .fc-theme-standard th {
            border: none !important;
        }

        .fc-scrollgrid {
            border: none !important;
        }

        .fc .fc-col-header-cell-cushion {
            padding: 8px 0;
            font-size: 11px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 800;
        }

        .fc-daygrid-day-frame {
            border-radius: 10px;
            overflow: hidden;
            margin: 1px;
            min-height: 45px !important;
            /* Force much smaller height */
        }

        .fc-daygrid-day.fc-day-today .fc-daygrid-day-frame {
            background: rgba(10, 132, 255, 0.2);
            border: 1px solid var(--blue);
        }

        .fc {
            font-size: 0.85em;
            /* Compact the text */
        }

        .fc-toolbar-title {
            font-size: 1.2em !important;
        }

        .glass-list-item {
            background: rgba(255, 255, 255, 0.15);
            /* Brighter list items */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        /* REMOVED GLARE EFFECTS ("Bagliori superflui") */
        .card::before {
            display: none;
        }

        .card:active {
            transform: scale(0.98);
        }

        /* üöÄ BUTTONS */
        .btn-primary {
            background: var(--accent-grad);
            color: white;
            border: none;
            padding: 16px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 15px;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 8px 20px -6px var(--primary-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s var(--ease-elastic);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:active {
            transform: scale(0.96);
        }

        .btn-icon-only {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            /* More subtle */
            color: var(--text-main);
            border: 1px solid var(--glass-border);
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }

        .btn-icon-only:active {
            background: rgba(255, 255, 255, 0.15);
        }

        /* üîç SEARCH FILTERS */
        .search-filter-pill {
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-filter-pill.active {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        /* üì± NAVIGATION (Floating Island) */
        #bottom-nav {
            position: fixed;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            min-width: 300px;
            padding: 8px 24px;
            height: 72px;

            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);

            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 100px;
            /* Pill */

            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: space-between;

            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        .nav-item {
            background: none;
            border: none;
            padding: 12px;
            color: rgba(255, 255, 255, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s var(--ease-smooth);
            position: relative;
        }

        .nav-item i {
            font-size: 24px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nav-item.active {
            color: white;
        }

        .nav-item.active i {
            color: #60a5fa;
            /* Brighter Blue */
            transform: translateY(-6px) scale(1.1);
            filter: drop-shadow(0 0 10px rgba(96, 165, 250, 0.7));
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: #60a5fa;
            border-radius: 50%;
            box-shadow: 0 0 8px #60a5fa;
        }

        /* üí¨ INPUTS */
        input,
        textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid var(--glass-border);
            padding: 16px;
            font-size: 15px;
            border-radius: var(--radius-md);
            font-family: inherit;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        input:focus,
        textarea:focus {
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        /* üóÇÔ∏è MODALS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .modal-content {
            background: linear-gradient(180deg, rgba(15, 23, 30, 0.95) 0%, #000 100%);
            border-top: 1px solid var(--glass-highlight);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: 32px 24px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* ‚ú® UTILS */
        .text-gradient {
            background: var(--accent-grad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background: rgba(37, 99, 235, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(37, 99, 235, 0.4);
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* FullCalendar Overrides */
        .fc {
            color: var(--text-muted);
        }

        .fc-toolbar-title {
            color: var(--text-main) !important;
            font-size: 18px !important;
        }

        .fc-daygrid-day-number {
            color: var(--text-muted) !important;
        }

        .fc-col-header-cell-cushion {
            color: var(--text-dim) !important;
            text-transform: uppercase;
            font-size: 12px;
        }

        .fc .fc-button-primary {
            background: var(--glass-highlight);
            border: none;
            backdrop-filter: blur(10px);
        }

        .fc .fc-button-active {
            background: var(--primary) !important;
            color: white !important;
        }

        .offline-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 159, 10, 0.15);
            border: 1px solid var(--orange);
            color: #fb923c;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }

        .offline-badge.show {
            display: block;
        }
    </style>
</head>

<body>
    <div id="app"></div>
    <div id="modals"></div>
    <div id="offline-badge" class="offline-badge">üì° Offline Mode</div>

    <nav id="bottom-nav">
        <button class="nav-item active" onclick="navigate('home')"><i class="ph-fill ph-house"></i></button>
        <button class="nav-item" onclick="navigate('market')"><i class="ph-fill ph-bag"></i></button>
        <button class="nav-item" onclick="navigate('feed')"><i class="ph-fill ph-chats-circle"></i></button>
        <button class="nav-item" onclick="navigate('planner')"><i class="ph-fill ph-calendar-check"></i></button>
        <button class="nav-item" onclick="navigate('profile')"><i class="ph-fill ph-user"></i></button>
    </nav>

    <script>
        // ‚≠ê Funzione universale per leggere le date di Argo
        function parseArgoDate(dateString) {
            if (!dateString) return new Date(0); // Fallback per date invalide

            // Try parsing as YYYY-MM-DD (e.g., from API or ISO)
            if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return new Date(dateString + 'T00:00:00');
            }

            // Try parsing as DD/MM/YYYY (e.g., from Argo HTML)
            if (typeof dateString === 'string' && dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const [day, month, year] = dateString.split('/');
                return new Date(`${year}-${month}-${day}T00:00:00`);
            }

            // Fallback for other formats or if it's already a Date object
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) return date;
            } catch (e) { }

            return new Date();
        }

        // ‚≠ê Calcola la media matematica dai voti di Argo
        function calcolaMedia(voti) {
            if (!voti || voti.length === 0) return null;
            const validi = voti.map(v => {
                let s = (v.valore || v.value || "").toString().replace(',', '.');
                return parseFloat(s);
            }).filter(n => !isNaN(n));

            if (validi.length === 0) return null;
            const somma = validi.reduce((a, b) => a + b, 0);
            return (somma / validi.length).toFixed(2);
        }

        const DIRECTORY = [
            { name: 'Alessandro Russo', class: '5B', status: 'online' },
            { name: 'Sofia Bianchi', class: '3A', status: 'offline' },
            { name: 'Luca Esposito', class: '4C', status: 'online' },
            { name: 'Giulia Conti', class: '5B', status: 'offline' },
            { name: 'Matteo Ferri', class: '2A', status: 'online' },
            { name: 'Chiara Romano', class: '1B', status: 'offline' },
            { name: 'Proff. Esposito', class: 'Docente', status: 'online' }
        ];

        // ---------------------------------------------
        // ‚öôÔ∏è CONFIGURATION
        // Lascia vuoto ("") se il server √® locale o se index.html √® servito da Flask.
        // Inserisci l'URL di Render (es: "https://g-connect-backend.onrender.com") se deploy su Netlify.
        const API_BASE_URL = "https://g-connect-backend.onrender.com";
        // ---------------------------------------------
        // üÜï PERSISTENT SESSION MANAGER
        const sessionManager = {
            save(sessionData) {
                try {
                    localStorage.setItem('argo_session', JSON.stringify(sessionData));
                    localStorage.setItem('argo_is_logged_in', 'true');
                    console.log("‚úÖ Sessione salvata");
                } catch (e) {
                    console.error("‚ùå Errore salvataggio sessione:", e);
                    alert("Errore salvataggio dati locali. Prova a disabilitare modalit√† incognito.");
                }
            },
            load() {
                try {
                    const saved = localStorage.getItem('argo_session');
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    console.error("‚ùå Errore caricamento sessione:", e);
                    return null;
                }
            },
            isLoggedIn() {
                return localStorage.getItem('argo_is_logged_in') === 'true';
            },
            clear() {
                localStorage.removeItem('argo_session');
                localStorage.removeItem('argo_tasks');
                localStorage.removeItem('argo_is_logged_in');
                localStorage.removeItem('argo_user'); // ‚≠ê Per persistere user
                console.log("üóëÔ∏è Sessione cancellata");
            }
        };

        // STATE MANAGEMENT
        const state = {
            view: 'login',
            user: { name: 'Andrea', class: '5B' }, // ‚≠ê Verr√† sovrascritto da localStorage
            isLoggedIn: false,
            isOffline: false,
            didup: { connected: false },
            feed: { search: '', classFilter: 'Tutte' },
            tasks: [], // ‚≠ê Inizializza vuoto, carica da localStorage
            posts: [], // Loaded from API
            marketItems: [], // Loaded from API
            messages: { 'Alessandro Russo': [{ text: 'Ciao Andrea! ', me: false }] },
            news: [
                { id: 128, title: 'Circolare n.  128 - Assemblea d\'Istituto 7 Febbraio', date: 'OGGI', url: 'https://www.liceogandhi.edu.it/categoria/storico-circolari/' },
                { id: 127, title: 'Circolare n. 127 - Variazione Calendario Scrutini', date: 'IERI', url: 'https://www.liceogandhi.edu.it/categoria/storico-circolari/' },
                { id: 126, title: 'Circolare n. 126 - Saldo viaggio d\'istruzione', date: '2 GG FA', url: 'https://www.liceogandhi.edu.it/categoria/storico-circolari/' }
            ],
            grades: [],
            announcements: [],
            voti: [],        // ‚≠ê Added based on user request
            promemoria: [],
            reminders: [],
            syncing: false,
            selectedDay: new Date().getDate(),
            stressLevels: JSON.parse(localStorage.getItem('argo_stress_levels') || '{}'),
            plannedTasks: JSON.parse(localStorage.getItem('argo_planned_tasks') || '{}')
        };

        const app = document.getElementById('app');
        const modalContainer = document.getElementById('modals');
        const offlineBadge = document.getElementById('offline-badge');

        // ‚≠ê INITIALIZE APP ON LOAD - Versione che funzionava
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üöÄ App Loading...");
            const isLoggedIn = sessionManager.isLoggedIn();
            const savedSession = sessionManager.load();

            if (isLoggedIn && savedSession) {
                console.log("‚úÖ Sessione valida trovata!");

                // ‚≠ê Carica tasks con done persistito e ricostruisci dateObj
                const cachedTasks = localStorage.getItem('argo_tasks');
                if (cachedTasks) {
                    try {
                        const parsed = JSON.parse(cachedTasks);
                        // ‚≠ê Ricostruisci dateObj da due_date quando viene caricato da localStorage
                        state.tasks = parsed.map(t => {
                            if (t.due_date) {
                                t.dateObj = new Date(t.due_date);
                                t.hasValidDate = !isNaN(t.dateObj.getTime());
                            }
                            return t;
                        });
                        console.log("üì¶ Compiti caricati:", state.tasks.length);
                    } catch (e) {
                        console.error("Errore cache tasks:", e);
                        state.tasks = [];
                    }
                }

                // ‚≠ê Carica user da localStorage
                const cachedUser = localStorage.getItem('argo_user');
                if (cachedUser) {
                    try {
                        state.user = JSON.parse(cachedUser);
                        console.log("üë§ Utente caricato:", state.user.name);
                    } catch (e) {
                        console.error("Errore caricamento user:", e);
                    }
                } else if (savedSession.student) {
                    state.user = savedSession.student;
                    localStorage.setItem('argo_user', JSON.stringify(state.user));
                }

                // ‚≠ê Carica voti e promemoria da localStorage
                const cachedVoti = localStorage.getItem('argo_voti');
                if (cachedVoti) {
                    try {
                        state.voti = JSON.parse(cachedVoti);
                        console.log("üìä Voti caricati da cache:", state.voti.length);
                    } catch (e) {
                        console.error("Errore caricamento voti:", e);
                        state.voti = [];
                    }
                }

                const cachedProm = localStorage.getItem('argo_promemoria');
                if (cachedProm) {
                    try {
                        state.promemoria = JSON.parse(cachedProm);
                        console.log("üì¢ Promemoria caricati da cache:", state.promemoria.length);
                    } catch (e) {
                        console.error("Errore caricamento promemoria:", e);
                        state.promemoria = [];
                    }
                }

                state.isLoggedIn = true;
                state.didup.connected = true;

                // ‚≠ê Carica Feed & Market da cache IMMEDIATAMENTE (prima del fetch)
                const cachedPosts = localStorage.getItem('argo_posts');
                if (cachedPosts) {
                    try {
                        state.posts = JSON.parse(cachedPosts);
                        console.log("üìù Feed caricato da cache:", state.posts.length);
                    } catch (e) { state.posts = []; }
                }
                const cachedMarket = localStorage.getItem('argo_market');
                if (cachedMarket) {
                    try {
                        state.marketItems = JSON.parse(cachedMarket);
                        console.log("üõí Market caricato da cache:", state.marketItems.length);
                    } catch (e) { state.marketItems = []; }
                }

                // ‚≠ê Fetch Feed & Market on startup (aggiorner√† con dati freschi)
                await Promise.all([fetchFeed(), fetchMarket()]);

                state.view = 'home';
                render();

                // ‚≠ê Sync in background passando la sessione salvata
                console.log("üîÑ Sincronizzazione in background...");
                await performSync(savedSession);
            } else {
                console.log("‚ùå No session - showing login");
                state.isLoggedIn = false;
                state.view = 'login';
                render();
            }
        });

        function updateOfflineBadge() {
            if (state.isOffline) {
                offlineBadge.classList.add('show');
            } else {
                offlineBadge.classList.remove('show');
            }
        }

        // ‚≠ê PERSISTENCE HELPERS (New API)
        async function fetchFeed() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/posts`);
                const data = await res.json();
                if (data.success) {
                    state.posts = data.data;
                    // ‚≠ê Persisti feed in localStorage
                    localStorage.setItem('argo_posts', JSON.stringify(state.posts));
                    console.log("üìù Feed caricato e salvato:", state.posts.length);
                }
            } catch (e) {
                console.error("Errore fetch feed:", e);
                // ‚≠ê Fallback: carica da localStorage se fetch fallisce
                const cached = localStorage.getItem('argo_posts');
                if (cached) {
                    state.posts = JSON.parse(cached);
                    console.log("üìù Feed caricato da cache:", state.posts.length);
                }
            }
        }

        async function fetchMarket() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/market`);
                const data = await res.json();
                if (data.success) {
                    state.marketItems = data.data;
                    // ‚≠ê Persisti market in localStorage
                    localStorage.setItem('argo_market', JSON.stringify(state.marketItems));
                    console.log("üõí Market caricato e salvato:", state.marketItems.length);
                }
            } catch (e) {
                console.error("Errore fetch market:", e);
                // ‚≠ê Fallback: carica da localStorage se fetch fallisce
                const cached = localStorage.getItem('argo_market');
                if (cached) {
                    state.marketItems = JSON.parse(cached);
                    console.log("üõí Market caricato da cache:", state.marketItems.length);
                }
            }
        }

        async function submitPost(postData) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/posts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });
                const data = await res.json();
                if (data.success) state.posts = data.data;
            } catch (e) { console.error("Errore submit post:", e); }
        }

        async function submitItem(itemData) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/market`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
                const data = await res.json();
                if (data.success) state.marketItems = data.data;
            } catch (e) { console.error("Errore submit item:", e); }
        }

        async function performSync(sessionData) {
            if (state.syncing) return;
            state.syncing = true;
            render();

            // ‚≠ê Fetch Global Data (Feed & Market)
            await Promise.all([fetchFeed(), fetchMarket()]);

            // ‚≠ê Usa la sessione passata o carica quella salvata (come nel codice vecchio)
            if (!sessionData) sessionData = sessionManager.load();
            if (!sessionData) {
                console.warn("‚ö†Ô∏è Nessuna sessione disponibile per sync");
                state.syncing = false;
                render();
                return;
            }

            try {
                console.log("üì§ Invio richiesta sync con sessione salvata");

                const response = await fetch(`${API_BASE_URL}/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(sessionData)
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                console.log("üì• Dati ricevuti dal server:", {
                    success: data.success,
                    tasksCount: data.tasks?.length || 0,
                    votiCount: data.voti?.length || 0,
                    promemoriaCount: data.promemoria?.length || data.announcements?.length || 0,
                    error: data.error
                });

                if (data.success && data.tasks) {
                    // ‚≠ê Gestione compiti
                    if (data.tasks.length === 0 && state.tasks.length > 0) {
                        console.warn("‚ö†Ô∏è Il server ha mandato 0 compiti. Mantengo quelli locali per sicurezza.");
                        state.isOffline = false;
                        updateOfflineBadge();
                        render();
                        state.syncing = false;
                        return;
                    }
                    updateTasks(data.tasks, true);

                    // ‚≠ê CRITICO: Aggiorna voti e salva SEMPRE
                    if (data.voti !== undefined) {
                        state.voti = Array.isArray(data.voti) ? data.voti : [];
                        localStorage.setItem('argo_voti', JSON.stringify(state.voti));
                    }

                    // ‚≠ê CRITICO: Aggiorna promemoria e salva SEMPRE
                    const promemoriaData = data.promemoria || data.announcements;
                    if (promemoriaData !== undefined) {
                        state.promemoria = Array.isArray(promemoriaData) ? promemoriaData : [];
                        localStorage.setItem('argo_promemoria', JSON.stringify(state.promemoria));
                    }

                    state.lastSync = new Date().toLocaleTimeString();
                    state.isOffline = false;
                    state.didup.connected = true;
                    updateOfflineBadge();
                    render();
                } else {
                    throw new Error("Sessione non valida");
                }
            } catch (e) {
                console.error("‚ö†Ô∏è Errore Sync:", e);
                if (e.message.includes("Sessione non valida")) {
                    if (sessionData && sessionData.storedUser && sessionData.storedPass) {
                        await performSilentLogin(sessionData.schoolCode, sessionData.storedUser, sessionData.storedPass);
                    } else {
                        sessionManager.clear();
                        state.isLoggedIn = false;
                        state.view = 'login';
                        alert("‚ùå Sessione scaduta. Effettua di nuovo il login.");
                        render();
                    }
                } else {
                    state.isOffline = true;
                    updateOfflineBadge();
                    render();
                }
            } finally {
                state.syncing = false;
            }
        }

        async function performSilentLogin(school, encodedUser, encodedPass) {
            try {
                const user = decodeURIComponent(escape(atob(encodedUser)));
                const pass = decodeURIComponent(escape(atob(encodedPass)));

                console.log("üîê Silent Login in corso...");

                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ schoolCode: school, username: user, password: pass })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();

                if (data.success) {
                    console.log("‚úÖ Silent Login riuscito!");
                    const newSession = {
                        ...data.session,
                        storedUser: encodedUser,
                        storedPass: encodedPass,
                        schoolCode: school
                    };
                    sessionManager.save(newSession);

                    if (data.tasks) updateTasks(data.tasks, true);
                    if (data.voti !== undefined) {
                        state.voti = Array.isArray(data.voti) ? data.voti : [];
                        localStorage.setItem('argo_voti', JSON.stringify(state.voti));
                    }
                    const promemoriaData = data.promemoria || data.announcements;
                    if (promemoriaData !== undefined) {
                        state.promemoria = Array.isArray(promemoriaData) ? promemoriaData : [];
                        localStorage.setItem('argo_promemoria', JSON.stringify(state.promemoria));
                    }

                    if (data.student) {
                        state.user = data.student;
                        localStorage.setItem('argo_user', JSON.stringify(state.user));
                    }

                    state.isOffline = false;
                    state.didup.connected = true;
                    state.lastSync = new Date().toLocaleTimeString();
                    updateOfflineBadge();
                    render();
                } else {
                    throw new Error(data.error || "Silent login fallito");
                }
            } catch (e) {
                console.error("‚ùå Silent login errore:", e);
                state.isOffline = true;
                updateOfflineBadge();
            }
        }

        function saveTasks() {
            try {
                const tasksToSave = state.tasks.map(t => ({
                    id: t.id,
                    text: t.text,
                    subject: t.subject,
                    due_date: t.due_date,
                    display_date: t.display_date,
                    hasValidDate: t.hasValidDate,
                    done: t.done
                }));
                localStorage.setItem('argo_tasks', JSON.stringify(tasksToSave));
                localStorage.setItem('argo_planned_tasks', JSON.stringify(state.plannedTasks));
                localStorage.setItem('argo_stress_levels', JSON.stringify(state.stressLevels));
                console.log("üíæ Dati persistiti correttamente");
            } catch (e) {
                console.error("‚ùå Errore salvataggio tasks:", e);
                alert("Errore salvataggio locale - controlla se il browser blocca storage o se sei in incognito.");
            }
        }


        function updateTasks(newTasks, shouldRender = false) {
            if (!newTasks) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // ‚≠ê Recupera stato 'done' persistito
            const localTasks = JSON.parse(localStorage.getItem('argo_tasks') || '[]');

            const formatted = newTasks.map(t => {
                // ‚≠ê Gerarchia Affidabilit√† Date: Consegna > Prova > Pubblicazione
                let rawDate = t.datCompito || t.due_date || t.dataProva || t.datGiorno || t.date;
                let dateObj = parseArgoDate(rawDate);
                let isoDate = dateObj.toISOString().split('T')[0];

                // ‚≠ê Cerca match per preservare done
                const match = localTasks.find(l =>
                    (l.id === t.id) ||
                    (l.text === (t.text || t.desCompito) && l.subject === (t.subject || t.materia))
                );

                return {
                    id: t.id || Math.random().toString(36).substr(2, 9),
                    text: t.text || t.desCompito || "Nessuna descrizione",
                    subject: t.subject || t.materia || 'Generico',
                    due_date: isoDate,
                    display_date: rawDate,
                    dateObj: dateObj,
                    hasValidDate: !isNaN(dateObj.getTime()) && dateObj.getTime() > 0,
                    done: match ? match.done : (t.done || false)
                };
            });

            // ‚≠ê Filtra e Ordina - SOLO quelli con data valida e non scaduti
            state.tasks = formatted
                .filter(t => t.hasValidDate && t.dateObj >= today)
                .sort((a, b) => a.dateObj - b.dateObj);

            saveTasks();
            if (shouldRender) render();
        }
        function render() {
            // Update nav
            document.querySelectorAll('.nav-item').forEach((el, idx) => {
                const views = ['home', 'market', 'feed', 'planner', 'profile'];
                if (views[idx] === state.view) el.classList.add('active');
                else el.classList.remove('active');
            });

            if (!state.isLoggedIn) {
                document.getElementById('bottom-nav').style.display = 'none';
                app.innerHTML = renderLogin();
            } else {
                document.getElementById('bottom-nav').style.display = 'flex';
                if (state.view === 'home') app.innerHTML = renderHome();
                else if (state.view === 'search') app.innerHTML = renderSearch();
                else if (state.view === 'market') app.innerHTML = renderMarket();
                else if (state.view === 'feed') app.innerHTML = renderFeed();
                else if (state.view === 'planner') app.innerHTML = renderPlanner();
                else if (state.view === 'profile') app.innerHTML = renderProfile();
                else if (state.view === 'chat') app.innerHTML = renderChat();
            }
        }

        function navigate(v) { state.view = v; render(); }

        function logout() {
            if (confirm('Sei sicuro di voler disconnettere? I tuoi planner e feed saranno mantenuti.')) {
                sessionManager.clear();
                state.isLoggedIn = false;
                state.didup.connected = false;
                state.user = { name: '', class: '' };
                state.tasks = [];
                state.voti = [];
                state.promemoria = [];
                state.isOffline = false;
                state.lastSync = null;
                state.view = 'login';
                // ‚≠ê NON cancellare plannedTasks, stressLevels e posts - persistono tra sessioni
                render();
                console.log('‚úÖ Logout completato - Planner e Feed preservati');
            }
        }

        function renderLogin() {
            // Se c'√® una sessione salvata ma l'utente vuole rifare login, mostra il form
            const savedSession = sessionManager.load();
            const hasSession = savedSession && sessionManager.isLoggedIn();

            return `
            <div class="view" style="height: 100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; padding: 24px;">
                <h1 style="margin-bottom:40px;">üìö G-Connect</h1>
                <p style="color:var(--text-secondary); margin-bottom:30px; text-align:center;">Accedi con le tue credenziali DidUP</p>
                <button class="btn-primary" onclick="openArgoLogin()" style="max-width:300px; cursor:pointer;">Accedi</button>
                ${hasSession ? `
                    <div style="margin-top:30px; padding:16px; background:rgba(255,255,255,0.05); border-radius:12px; text-align:center; max-width:300px;">
                        <div style="font-size:12px; color:var(--text-secondary); margin-bottom:8px;">Sessione attiva trovata</div>
                        <div style="font-size:14px; font-weight:600; margin-bottom:12px;">${state.user?.name || 'Utente'}</div>
                        <button onclick="logout()" style="background:none; border:1px solid rgba(255,255,255,0.2); color:var(--text-secondary); padding:8px 16px; border-radius:8px; cursor:pointer; font-size:12px; width:100%;">
                            Disconnetti e accedi con altro account
                        </button>
                    </div>
                ` : ''}
            </div>`;
        }

        function getSubjectColor(subject) {
            if (!subject) return 'var(--blue)';
            const s = subject.toLowerCase();
            if (s.includes('ita')) return '#FF3B30'; // Red
            if (s.includes('mat')) return '#007AFF'; // Blue
            if (s.includes('ing')) return '#5856D6'; // Indigo
            if (s.includes('storia') || s.includes('geo')) return '#FF9500'; // Orange
            if (s.includes('scienza') || s.includes('biol')) return '#34C759'; // Green
            if (s.includes('fisica')) return '#AF52DE'; // Purple
            if (s.includes('arte')) return '#FF2D55'; // Pink
            if (s.includes('ed')) return '#5AC8FA'; // Light Blue
            if (s.includes('rel')) return '#FFCC00'; // Yellow

            // Fallback: Hash-based color
            let hash = 0;
            for (let i = 0; i < subject.length; i++) {
                hash = subject.charCodeAt(i) + ((hash << 5) - hash);
            }
            return `hsl(${Math.abs(hash) % 360}, 70%, 60%)`;
        }

        function renderHome() {
            // Count completed tasks for today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTasks = state.tasks.filter(t => {
                if (!t.dateObj) return false;
                const d = new Date(t.dateObj);
                d.setHours(0, 0, 0, 0);
                return d.getTime() === today.getTime();
            });
            const completedToday = todayTasks.filter(t => t.done).length;
            const totalToday = todayTasks.length;

            return `
            <div class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <!-- Removed Greeting as requested -->
                        <h1 style="color: white; text-align: left;">Dashboard</h1>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <div onclick="showSearchModal()" style="width: 44px; height: 44px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor:pointer;" title="Cerca">
                            <i class="ph-bold ph-magnifying-glass" style="font-size: 20px;"></i>
                        </div>
                        <button onclick="openArgoLogin()" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="ph-fill ph-user-switch"></i> Cambia Profilo
                        </button>
                    </div>
                </div>
                
                ${!state.didup.connected ? `
                    <div class="card" style="background: rgba(255, 159, 10, 0.15); border: 1px solid var(--orange); margin-bottom: 20px; padding: 16px; display: flex; align-items: center; gap: 12px;">
                        <i class="ph ph-warning" style="color: var(--orange); font-size: 24px;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px; color: white;">DidUP Non Connesso</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Collega il tuo account DidUP per vedere voti, compiti e promemoria</div>
                        </div>
                        <button onclick="openArgoLogin()" style="background: var(--orange); color: black; padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; font-size: 12px; cursor: pointer;">
                            Connetti
                        </button>
                    </div>
                ` : ''}

                <!-- CIRCULARS -->
                <div style="margin-bottom: 30px;">
                    <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom: 16px;">
                        <h2 style="margin:0; text-align: left;">Ultime Circolari</h2>
                        <button onclick="window.open('https://www.liceogandhi.edu.it/categoria/storico-circolari/','_blank')" style="background:none; border:none; color:var(--blue); font-size:14px; font-weight:600; cursor:pointer;">Vedi tutte</button>
                    </div>
                    <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; margin: 0 -24px; padding-left: 24px; scrollbar-width: none;">
                        ${state.news.map(n => `
                            <div onclick="window.open('${n.url}', '_blank')" style="min-width: 260px; height: 150px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 18px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; cursor:pointer;">
                                <i class="ph-fill ph-file-pdf" style="position: absolute; right: -10px; bottom: -10px; font-size: 80px; color: rgba(255,255,255,0.05); transform: rotate(-15deg);"></i>
                                <div>
                                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
                                        <i class="ph-fill ph-file-pdf" style="color: var(--red); font-size: 16px;"></i>
                                        <span style="color: rgba(255,255,255,0.6); font-size: 11px; font-weight: 700; text-transform: uppercase;">CIRCOLARE</span>
                                    </div>
                                    <h3 style="margin: 0; font-size: 17px; line-height: 1.3; font-weight: 600; color: white; text-align: left;">${n.title}</h3>
                                </div>
                                <span style="font-size: 12px; color: var(--blue); font-weight: 600;">Apri documento <i class="ph-bold ph-arrow-up-right" style="font-size:10px;"></i></span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- WIDGETS SECTION -->
                <h2 style="margin-bottom: 16px; text-align: left;">Panoramica</h2>
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    
                    <!-- GRADE AVERAGE WIDGET -->
                    <div class="card glass-panel" onclick="showVotiView()" style="flex: 1; padding: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 0; cursor:pointer;">
                        <div style="position: relative; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; margin-bottom: 6px;">
                            ${(() => {
                    const media = calcolaMedia(state.voti);
                    const m = media ? parseFloat(media) : 0;
                    const percent = (m / 10) * 188;

                    let color = 'var(--red)';
                    if (m >= 6.00) color = 'var(--green)';
                    else if (m >= 5.50) color = '#F5D90A';

                    return `
                                    <svg width="64" height="64" viewBox="0 0 70 70">
                                        <circle cx="35" cy="35" r="30" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="6" />
                                        <circle cx="35" cy="35" r="30" fill="none" stroke="${color}" stroke-width="6" stroke-dasharray="188" stroke-dashoffset="${188 - percent}" transform="rotate(-90 35 35)" stroke-linecap="round" />
                                    </svg>
                                    <span style="position: absolute; font-size: 16px; font-weight: 700; color: white;">${media ? m.toFixed(2) : '--'}</span>
                                `;
                })()}
                        </div>
                        <span style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 700; text-transform: uppercase;">Media</span>
                    </div>

                    <!-- STRESS WIDGET -->
                    <div class="card glass-panel" onclick="showStressModal()" style="flex: 1; padding: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 0; cursor:pointer;">
                        <div style="position: relative; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; margin-bottom: 6px;">
                             ${(() => {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const level = state.stressLevels[todayStr] || 0;
                    const colors = ['rgba(255,255,255,0.1)', '#4ade80', '#fbbf24', '#f87171', '#ef4444', '#7f1d1d'];
                    const color = colors[level] || colors[0];
                    return `
                                     <div style="width: 44px; height: 44px; background: ${color}20; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: ${color}; border: 1px solid ${color}40;">
                                        <i class="ph-fill ph-activity" style="font-size: 22px;"></i>
                                    </div>
                                    ${level > 0 ? `<div style="position: absolute; bottom: 0; right: 0; background: ${color}; color: white; font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 8px;">${level}</div>` : ''}
                                 `;
                })()}
                        </div>
                        <span style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 700; text-transform: uppercase;">Stress</span>
                    </div>
                </div>

                <!-- MINI PLANNER (INDISPENSABILI OGGI) -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin:0; text-align: left;">Organizza Oggi</h2>
                    <button onclick="showOrganizeStudyModal()" style="background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <i class="ph-bold ph-plus"></i>
                    </button>
                </div>
                <div class="card glass-panel" onclick="navigate('planner')" style="padding: 20px; cursor: pointer; background: rgba(255,255,255,0.15);">
                     ${(() => {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const plannedIds = state.plannedTasks[todayStr] || [];
                    const plannedTasks = state.tasks.filter(t => plannedIds.includes(t.id));

                    if (plannedTasks.length > 0) {
                        return `
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    ${plannedTasks.map(t => `
                                        <div style="display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px;">
                                            <div onclick="event.stopPropagation(); toggleTask('${t.id}')" style="width: 20px; height: 20px; border: 2px solid ${t.done ? 'var(--green)' : 'var(--orange)'}; background: ${t.done ? 'var(--green)' : 'transparent'}; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                                ${t.done ? '<i class="ph-bold ph-check" style="font-size: 12px; color: black;"></i>' : ''}
                                            </div>
                                            <div style="flex: 1;">
                                                <span style="font-size: 15px; font-weight: 500; color: white; opacity: ${t.done ? 0.5 : 1}; text-decoration: ${t.done ? 'line-through' : 'none'}">${t.text}</span>
                                                <div style="font-size: 11px; color: var(--blue); font-weight: 700;">${t.subject}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                             `;
                    } else {
                        return `
                                <div onclick="event.stopPropagation(); showOrganizeStudyModal()" style="text-align: center; padding: 30px 10px; opacity: 0.8; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;">
                                    <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px dashed rgba(255,255,255,0.3);">
                                        <i class="ph-bold ph-plus" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <div style="font-weight: 500; font-size: 14px;">Tocca per pianificare la giornata</div>
                                </div>
                             `;
                    }
                })()}
                </div>
            </div>
            `;
        }

        function renderMarket() {
            return `
                <div class="view">
                   <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <h1>Market Libri</h1>
                        <button onclick="openNewItemModal()" style="background:var(--green); color:black; padding:8px 16px; border-radius:20px; border:none; font-weight:700; cursor:pointer;">+ Vendi</button>
                    </div> 
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        ${state.marketItems.map(item => `
                            <div class="card" style="padding:0; overflow:hidden; display:flex; flex-direction:column; margin:0; height: 100%;">
                                <div style="height:140px; background:#333; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                    ${item.image ? `<img src="${item.image}" style="width:100%; height:100%; object-fit:cover;">` : `<i class="ph ph-book-open" style="font-size:40px; color:rgba(255,255,255,0.2);"></i>`}
                                </div>
                                <div style="padding:12px; flex:1; display:flex; flex-direction:column; justify-content:space-between;">
                                    <div>
                                        <div style="font-weight:600; font-size:15px; margin-bottom:4px; line-height:1.2;">${item.title}</div>
                                        <div style="font-size:12px; color:var(--text-secondary);">Venduto da ${item.seller}</div>
                                    </div>
                                    <div style="margin-top:8px; font-weight:700; color:var(--green); font-size:16px;">${item.price}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSearch() {
            return `
                <div class="view" style="padding-top: 0;">
                    <div class="search-container">
                         <div style="display:flex; align-items:center; gap:10px; margin: 10px 0;">
                             <button onclick="navigate('home')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;"><i class="ph ph-arrow-left"></i></button>
                             <h1 style="margin:0;">Community</h1>
                         </div>
                        <div style="position: relative;">
                            <i class="ph ph-magnifying-glass" style="position: absolute; left: 14px; top: 12px; color: var(--text-secondary); font-size: 20px;"></i>
                            <input id="search-input" type="text" placeholder="Cerca studente..." oninput="filterStudents(this.value)" style="padding-left: 44px; margin-bottom: 0;">
                        </div>
                    </div>
                    
                    <div id="student-list" style="padding-top: 10px;"></div>
                </div>
            `;
        }

        function filterStudents(q) {
            const list = document.getElementById('student-list');
            if (!list) return;

            const filtered = DIRECTORY.filter(u => u.name.toLowerCase().includes(q.toLowerCase()));

            if (filtered.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--text-secondary);">Nessun utente trovato</div>`;
                return;
            }

            list.innerHTML = `
                ${q === '' ? `<h3 style="margin-bottom: 12px;">Suggeriti</h3>` : ''}
                ${filtered.map(u => `
                    <div onclick="openChat('${u.name}')" style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor:pointer;">
                        <div style="position: relative; margin-right: 16px;">
                            <div style="width: 50px; height: 50px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px;">${u.name[0]}</div>
                            ${u.status === 'online' ? `<div style="position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; background: var(--green); border: 2px solid black; border-radius: 50%;"></div>` : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 17px; margin-bottom: 2px;">${u.name}</div>
                            <div style="color: var(--text-secondary); font-size: 13px;">Classe ${u.class}</div>
                        </div>
                        <button style="background: rgba(10, 132, 255, 0.15); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; color: var(--blue);">
                            <i class="ph-fill ph-chat-circle-dots" style="font-size: 20px;"></i>
                        </button>
                    </div>
                `).join('')}
            `;
        }

        function renderFeed() {
            // Filter Posts
            let displayPosts = state.posts;

            // 1. Class Filter
            if (state.feed.classFilter !== 'Tutte') {
                displayPosts = displayPosts.filter(p => p.class === state.feed.classFilter);
            }

            // 2. Search Filter (Search in Author or Text)
            if (state.feed.search) {
                const q = state.feed.search.toLowerCase();
                displayPosts = displayPosts.filter(p =>
                    p.author.toLowerCase().includes(q) ||
                    p.text.toLowerCase().includes(q)
                );
            }

            // Find Users (if searching)
            let foundUsers = [];
            if (state.feed.search) {
                foundUsers = DIRECTORY.filter(u => u.name.toLowerCase().includes(state.feed.search.toLowerCase()));
            }

            // Get unique classes for filter
            const allClasses = ['Tutte', ...new Set(DIRECTORY.map(u => u.class))];

            return `
            <div class="view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h1>Feed</h1>
                    <button onclick="openNewPostModal()" style="background:var(--blue); padding:8px 16px; border-radius:20px; border:none; color:white; font-weight:600; cursor:pointer;">+ Post</button>
                </div>

                <!-- POLL WIDGET (MOVED TO FEED) -->
                ${renderPollWidget()}

                <!-- Search Bar -->
                <div style="position:relative; margin-bottom: 16px;">
                     <i class="ph ph-magnifying-glass" style="position: absolute; left: 14px; top: 12px; color: var(--text-secondary); font-size: 20px;"></i>
                     <input type="text" placeholder="Cerca persone o post..." value="${state.feed.search}" oninput="updateFeedSearch(this.value)" style="padding-left: 44px; margin-bottom: 0;">
                </div>

                <!-- Class Filters -->
                <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin: 0 -24px 16px -24px; padding-left: 24px; scrollbar-width: none;">
                    ${allClasses.map(c => `
                        <button onclick="setFeedClass('${c}')" style="
                            padding: 6px 16px; 
                            border-radius: 16px; 
                            border: 1px solid ${state.feed.classFilter === c ? 'var(--blue)' : 'rgba(255,255,255,0.2)'}; 
                            background: ${state.feed.classFilter === c ? 'var(--blue)' : 'transparent'}; 
                            color: white; 
                            font-weight: 600; 
                            white-space: nowrap;
                            font-size: 13px;
                            transition: all 0.2s;
                            cursor: pointer;
                        ">${c}</button>
                    `).join('')}
                </div>

                <!-- Found Users Section -->
                ${foundUsers.length > 0 ? `
                    <div style="margin-bottom: 24px;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom: 12px;">
                            <i class="ph-fill ph-users" style="color:var(--blue);"></i>
                            <h3 style="margin:0;">Persone Correlate</h3>
                        </div>
                        ${foundUsers.map(u => `
                             <div onclick="openChat('${u.name}')" style="display: flex; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 16px; margin-bottom: 8px; cursor:pointer; border: 1px solid rgba(255,255,255,0.05);">
                                <div style="width: 36px; height: 36px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 12px; border: 1px solid rgba(255,255,255,0.1);">${u.name[0]}</div>
                                <div style="flex:1;">
                                    <div style="font-weight: 600; font-size: 15px;">${u.name}</div>
                                    <div style="color: var(--text-secondary); font-size: 11px;">Classe ${u.class}</div>
                                </div>
                                <div style="background: rgba(10, 132, 255, 0.1); padding: 6px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; color: var(--blue);">MESSAGE</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Posts List -->
                ${displayPosts.length > 0 ? displayPosts.map(post => `
                    <div class="card">
                        <div style="display:flex; gap:12px; margin-bottom:12px;">
                            <div style="width:40px; height:40px; background:${post.anon ? '#333' : 'var(--blue)'}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;">${post.anon ? '?' : post.author[0]}</div>
                            <div>
                                <div style="font-weight:700;">${post.anon ? 'Anonimo' : post.author}</div>
                                <div style="font-size:12px; opacity:0.6;">${post.anon ? 'Studente' : post.class}</div>
                            </div>
                        </div>
                        <p>${post.text}</p>
                        ${post.image ? `<img src="${post.image}" style="width:100%; border-radius:12px; margin-bottom:12px;">` : ''}
                        <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; display:flex; gap:20px;">
                            <button onclick="toggleLike(${post.id})" style="background:none; border:none; color:${post.liked ? 'var(--red)' : 'var(--text-secondary)'}; cursor:pointer;"><i class="${post.liked ? 'ph-fill' : 'ph'} ph-heart"></i> ${post.likes}</button>
                            <button style="background:none; border:none; color:var(--text-secondary); cursor:pointer;"><i class="ph ph-chat-circle"></i> Commenta</button>
                        </div>
                    </div>
                `).join('') : `<div style="text-align:center; padding:40px; opacity:0.5;">Nessun post trovato</div>`}
            </div>`;
        }

        function renderChat() {
            const msgs = state.messages[state.currentChatUser] || [];
            return `
            <div class="view" style="display:flex; flex-direction:column; height:100vh; padding:0;">
                <div style="padding:20px; padding-top:60px; background:rgba(28,28,30,0.9); display:flex; align-items:center; gap:16px; border-bottom:1px solid rgba(255,255,255,0.1);">
                    <button onclick="navigate('search')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;"><i class="ph ph-arrow-left"></i></button>
                    <h2>${state.currentChatUser}</h2>
                </div>
                <div id="chat-history" style="flex:1; overflow-y:auto; padding:20px;">
                    ${msgs.map(m => `<div class="message-bubble ${m.me ? 'msg-me' : 'msg-other'}">${m.text}</div>`).join('')}
                </div>
                <div style="padding:20px; padding-bottom: 40px; background:black; display:flex; gap:10px; border-top:1px solid rgba(255,255,255,0.1);">
                    <input id="msg-input" placeholder="Messaggio..." style="margin-bottom:0;">
                    <button onclick="sendMessage()" style="background:var(--blue); width:50px; border-radius:50%; border:none; color:white; cursor:pointer;">
                        <i class="ph-fill ph-paper-plane-right"></i>
                    </button>
                </div>
            </div>`;
        }

        function renderPlanner() {
            setTimeout(() => {
                const calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                    const existingCalendar = calendarEl._fullCalendar;
                    if (existingCalendar) existingCalendar.destroy();

                    // ‚≠ê Ottimizzazione: Mostra solo questa settimana e la prossima
                    const today = new Date();

                    // Inizio: Luned√¨ di questa settimana
                    const day = today.getDay();
                    const diffToMonday = today.getDate() - (day === 0 ? 6 : day - 1);
                    const startOfWeek = new Date(new Date(today).setDate(diffToMonday));
                    startOfWeek.setHours(0, 0, 0, 0);

                    // Fine: Domenica della prossima settimana
                    const endOfNextWeek = new Date(startOfWeek);
                    endOfNextWeek.setDate(startOfWeek.getDate() + 13); // +14 days - 1
                    endOfNextWeek.setHours(23, 59, 59, 999);

                    const calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridTwoWeeks',
                        views: {
                            dayGridTwoWeeks: {
                                type: 'dayGrid',
                                duration: { weeks: 2 }
                            }
                        },
                        locale: 'it',
                        themeSystem: 'standard',
                        firstDay: 1, // Luned√¨
                        height: 'auto',
                        validRange: {
                            start: startOfWeek.toISOString().split('T')[0]
                        },
                        headerToolbar: { left: 'title', center: '', right: 'prev,next' },
                        dayCellContent: function (arg) {
                            return arg.dayNumberText.replace(/[a-z]/gi, '').trim();
                        },
                        events: state.tasks
                            .filter(t => t.due_date && t.hasValidDate)
                            .map(t => ({
                                title: `${t.subject}: ${t.text.substring(0, 30)}${t.text.length > 30 ? '...' : ''}`,
                                start: t.due_date,
                                color: t.done ? '#30D158' : '#0A84FF',
                                textColor: t.done ? '#000' : '#fff',
                                extendedProps: {
                                    fullText: t.text,
                                    subject: t.subject
                                }
                            })),
                        eventClick: function (info) {
                            const event = info.event;
                            modalContainer.innerHTML = `
                                <div class="modal-overlay" onclick="closeModal(event)">
                                    <div class="modal-content glass-panel">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                            <h2 style="margin: 0;">Dettaglio Compito</h2>
                                            <i class="ph ph-x" onclick="closeModal()" style="cursor:pointer; font-size: 24px;"></i>
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            <div style="font-size: 11px; color: var(--blue); font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Materia</div>
                                            <div style="font-size: 18px; font-weight: 600; color: white;">${event.extendedProps.subject}</div>
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            <div style="font-size: 11px; color: var(--blue); font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Descrizione</div>
                                            <div style="font-size: 16px; color: white; line-height: 1.5;">${event.extendedProps.fullText}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--blue); font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Scadenza</div>
                                            <div style="font-size: 16px; color: white; display: flex; align-items: center; gap: 6px;">
                                                <i class="ph ph-calendar"></i>
                                                ${new Date(event.start).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        },
                        dateClick: function (info) {
                            const tasksForDay = state.tasks.filter(t => {
                                if (!t.due_date) return false;
                                const taskDate = new Date(t.due_date);
                                const clickedDate = new Date(info.dateStr);
                                return taskDate.toDateString() === clickedDate.toDateString();
                            });

                            if (tasksForDay.length > 0) {
                                const tasksList = tasksForDay.map(t => `‚Ä¢ ${t.subject}: ${t.text}`).join('\\n');
                                alert(`Compiti per ${info.dateStr}:\\n\\n${tasksList}`);
                            } else {
                                alert(`Nessun compito per ${info.dateStr}`);
                            }
                        }
                    });
                    calendar.render();
                    calendarEl._fullCalendar = calendar;
                }
            }, 100);

            return `
            <div class="view" style="padding: 20px; padding-bottom: 100px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h1 style="margin: 0;">Planner</h1>
                        <button onclick="addManualReminder()" style="background: rgba(255,255,255,0.1); border: none; width: 28px; height: 28px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="ph-bold ph-plus" style="font-size: 14px;"></i>
                        </button>
                    </div>
                    <button onclick="performSync()" style="background: var(--blue); color: white; border: none; padding: 10px 16px; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="ph ph-arrow-clockwise" style="font-size: 16px; ${state.syncing ? 'animation: spin 1s linear infinite;' : ''}"></i>
                        ${state.syncing ? 'Sincronizzazione...' : 'Sincronizza'}
                    </button>
                </div>

                <h3 style="text-align: center; margin-bottom: 8px; font-size: 11px;">IL TUO CALENDARIO</h3>
                <div style="background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.15);">
                    <div id="calendar" style="font-size: 0.75em;"></div>
                </div>

                <!-- WEEKLY PLAN SECTION (REORDERED) -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h3 style="margin:0; text-align: left; color: white;">Agenda della settimana</h3>
                        <button onclick="showTasksBySubjectModal()" style="background: var(--blue); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="ph-bold ph-circles-four"></i>
                            Per Materia
                        </button>
                    </div>
                    <button onclick="showPlanWeekModal()" style="background: rgba(255,255,255,0.1); border: none; width: 28px; height: 28px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <i class="ph-bold ph-plus" style="font-size: 14px;"></i>
                    </button>
                </div>
                <div class="card glass-panel" style="padding: 16px; background: rgba(255,255,255,0.05); margin-bottom: 24px;">
                    ${(() => {
                    // ‚≠ê Raccogli tutti i task pianificati con le loro date
                    const plannedWithDates = [];
                    Object.entries(state.plannedTasks).forEach(([dateStr, taskIds]) => {
                        taskIds.forEach(id => {
                            const task = state.tasks.find(t => t.id === id);
                            if (task) {
                                plannedWithDates.push({ ...task, plannedDate: dateStr });
                            }
                        });
                    });

                    // Ordina per data pianificata
                    plannedWithDates.sort((a, b) => new Date(a.plannedDate) - new Date(b.plannedDate));

                    if (plannedWithDates.length > 0) {
                        const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
                        return plannedWithDates.map(t => {
                            const d = new Date(t.plannedDate);
                            const dayLabel = `${dayNames[d.getDay()]} ${d.getDate()}`;
                            return `
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px;">
                                    <div style="min-width: 50px; font-size: 11px; font-weight: 800; color: var(--orange); text-transform: uppercase;">${dayLabel}</div>
                                    <div onclick="toggleTask('${t.id}')" style="width: 20px; height: 20px; border: 2px solid ${t.done ? 'var(--green)' : getSubjectColor(t.subject)}; background: ${t.done ? 'var(--green)' : 'transparent'}; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        ${t.done ? '<i class="ph-bold ph-check" style="font-size: 12px; color: black;"></i>' : ''}
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 14px; color: white; font-weight: 500; ${t.done ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.text}</div>
                                        <div style="font-size: 10px; color: ${getSubjectColor(t.subject)}; font-weight: 700; text-transform: uppercase;">${t.subject}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        return `<div style="text-align: center; opacity: 0.5; font-size: 13px; padding: 10px;">Nessun compito pianificato.</div>`;
                    }
                })()}
                </div>
            </div>`;
        }

        function showPlanWeekModal() {
            modalContainer.innerHTML = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal-content glass-panel" style="max-width: 450px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin:0;">Pianifica Settimana</h2>
                            <i class="ph ph-x" onclick="closeModal()" style="cursor:pointer; font-size: 24px;"></i>
                        </div>
                        <p style="font-size: 14px; opacity: 0.7; margin-bottom: 20px;">Assegna i compiti ai giorni della settimana per organizzare il tuo studio.</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 20px; max-height: 500px; overflow-y: auto;">
                            ${state.tasks.filter(t => !t.done).map(t => {
                return `
                                    <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                                        <div style="font-weight: 700; color: white; margin-bottom: 4px;">${t.text}</div>
                                        <div style="font-size: 11px; color: var(--blue); margin-bottom: 12px;">${t.subject}</div>
                                        
                                        <div style="display: flex; justify-content: space-between; gap: 4px;">
                                            ${['L', 'M', 'M', 'G', 'V', 'S', 'D'].map((dayLabel, i) => {
                    const dayIndex = (i + 1) % 7; // Monday is 1, Sunday is 0
                    // Calculate the date for this day of the current week
                    const today = new Date();
                    const d = today.getDay();
                    const diff = today.getDate() - (d === 0 ? 6 : d - 1) + i;
                    const date = new Date(new Date(today).setDate(diff));
                    const dateStr = date.toISOString().split('T')[0];
                    const isPlanned = state.plannedTasks[dateStr] && state.plannedTasks[dateStr].includes(t.id);

                    return `
                                                    <div onclick="togglePlanDay('${t.id}', '${dateStr}')" style="flex:1; height: 32px; border-radius: 8px; background: ${isPlanned ? 'var(--blue)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${isPlanned ? 'var(--blue)' : 'rgba(255,255,255,0.1)'}; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; cursor: pointer; color: ${isPlanned ? 'white' : 'rgba(255,255,255,0.5)'};">
                                                        ${dayLabel}
                                                    </div>
                                                `;
                }).join('')}
                                        </div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                        <button onclick="closeModal()" class="btn-primary" style="margin-top: 20px;">Fatto</button>
                    </div>
                </div>
            `;
        }

        function togglePlanDay(taskId, dateStr) {
            if (!state.plannedTasks[dateStr]) state.plannedTasks[dateStr] = [];
            const index = state.plannedTasks[dateStr].indexOf(taskId);
            if (index > -1) {
                state.plannedTasks[dateStr].splice(index, 1);
            } else {
                state.plannedTasks[dateStr].push(taskId);
            }
            saveTasks();
            // ‚≠ê Solo refresh modal, NO render() per evitare scatti
            showPlanWeekModal();
        }

        function selectDay(day) {
            state.selectedDay = day;
            render();
        }

        function showVotiView() {
            modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content" style="max-height:85vh; overflow-y:auto; padding: 0;">
                    <div style="position: sticky; top: 0; background:rgba(28,28,30,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); padding: 20px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center; z-index: 10;">
                        <h2 style="margin:0;">Voti DidUP</h2>
                        <button onclick="closeModal()" style="background:none; border:none; color:var(--blue); font-weight:700; font-size:16px;">Chiudi</button>
                    </div>
                    <div style="padding: 20px;">
                        ${renderVoti()}
                    </div>
                </div>
            </div>`;
        }

        function renderVoti() {
            // ‚≠ê DEBUG: Log completo per capire cosa c'√®
            console.log("üéì renderVoti chiamato - state.voti:", state.voti);
            console.log("üéì renderVoti chiamato - state.grades:", state.grades);
            console.log("üéì renderVoti chiamato - localStorage argo_voti:", localStorage.getItem('argo_voti'));

            // ‚≠ê Prova prima voti, poi grades
            const votiData = (state.voti && state.voti.length > 0) ? state.voti :
                ((state.grades && state.grades.length > 0) ? state.grades : []);

            console.log("üéì votiData finale:", votiData);

            if (votiData.length === 0) {
                return `
                    <div style="text-align:center; padding: 40px; color: var(--text-secondary);">
                        <i class="ph ph-graduation-cap" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px; display: block;"></i>
                        Nessun voto caricato<br>
                        <span style="font-size: 12px; margin-top: 8px; display: block;">I voti verranno caricati dopo la sincronizzazione con DidUP</span>
                        <button onclick="performSync(); closeModal();" style="background:var(--blue); color:white; padding:10px 20px; border-radius:10px; border:none; margin-top:16px; cursor:pointer; font-weight:600;">
                            <i class="ph ph-arrow-clockwise"></i> Sincronizza Ora
                        </button>
                        <div style="margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 11px; text-align: left;">
                            <strong>Debug Info:</strong><br>
                            state.voti.length: ${state.voti?.length || 0}<br>
                            state.grades.length: ${state.grades?.length || 0}<br>
                            localStorage: ${localStorage.getItem('argo_voti') ? 'Presente' : 'Vuoto'}
                        </div>
                    </div>`;
            }

            const media = calcolaMedia(votiData);
            const mediaNum = media ? parseFloat(media) : null;

            return `
                <div style="margin-bottom: 20px;">
                    <div class="card glass-panel" style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.4), rgba(79, 70, 229, 0.4)); border: 1px solid var(--blue); padding: 20px; text-align: center; margin-bottom: 16px; box-shadow: 0 10px 40px rgba(37, 99, 235, 0.3);">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Media Generale</div>
                        <div style="font-size: 56px; font-weight: 800; color: white; margin-bottom: 4px; text-shadow: 0 4px 12px rgba(0,0,0,0.3);">${media || '--'}</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.7);">Su ${votiData.length} voti registrati</div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${votiData.map(v => {
                const val = (v.valore || v.value || '').toString();
                const mat = v.materia || v.subject || 'Materia non specificata';
                const data = v.data || v.date || 'Data non disponibile';
                const tipo = v.tipo || v.type || '';
                const valNum = parseFloat(val.replace(',', '.'));
                const isSufficient = !isNaN(valNum) && valNum >= 6;
                const color = isSufficient ? 'var(--green)' : '#FF453A';

                return `
                            <div class="glass-list-item" style="padding: 16px; display: flex; align-items: center; gap: 16px; border-left: 4px solid ${color};">
                                <div style="width: 60px; height: 60px; border-radius: 16px; background: ${color}20; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 800; color: ${color}; border: 1px solid ${color}40; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                                    ${val}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 17px; color: white; margin-bottom: 4px;">${mat}</div>
                                    ${tipo ? `<div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 700; letter-spacing:0.5px; margin-bottom: 2px;">${tipo}</div>` : ''}
                                    <div style="font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px;">
                                        <i class="ph ph-calendar" style="font-size: 12px;"></i>
                                        ${data}
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function showBachecaModal() {
            // ‚≠ê Prova prima promemoria, poi announcements
            const dataBacheca = state.promemoria && state.promemoria.length > 0 ? state.promemoria :
                (state.announcements && state.announcements.length > 0 ? state.announcements : []);

            console.log("üì¢ Rendering bacheca - state.promemoria:", state.promemoria?.length || 0, "state.announcements:", state.announcements?.length || 0);

            modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content" style="max-height:85vh; overflow-y:auto; padding: 0;">
                    <div style="position: sticky; top: 0; background:rgba(28,28,30,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); padding: 20px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center; z-index: 10;">
                        <h2 style="margin:0;">Bacheca & Avvisi</h2>
                        <button onclick="closeModal()" style="background:none; border:none; color:var(--orange); font-weight:700; font-size:16px; cursor:pointer;">Chiudi</button>
                    </div>
                    <div style="padding: 20px; display:flex; flex-direction:column; gap:12px;">
                        ${dataBacheca.length === 0 ?
                    `<div style="text-align:center; padding: 40px; color: var(--text-secondary);">
                        <i class="ph ph-megaphone" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px; display: block;"></i>
                        Nessun avviso in bacheca<br>
                        <span style="font-size: 12px; margin-top: 8px; display: block;">Gli avvisi verranno caricati dopo la sincronizzazione con DidUP</span>
                        <button onclick="performSync(); closeModal();" style="background:var(--orange); color:black; padding:10px 20px; border-radius:10px; border:none; margin-top:16px; cursor:pointer; font-weight:600;">
                            <i class="ph ph-arrow-clockwise"></i> Sincronizza Ora
                        </button>
                    </div>` :
                    dataBacheca.map(item => {
                        const data = item.data || item.date || item.datGiorno || 'Data non disponibile';
                        const autore = item.autore || item.docente || 'Docente';
                        const oggetto = item.oggetto || item.titolo || item.title || 'Avviso';
                        const testo = item.testo || item.text || item.descrizione || item.description || '';
                        const url = item.url || item.allegato || null;

                        return `
                                <div class="glass-list-item" style="border-left: 4px solid var(--orange); background: rgba(255, 159, 10, 0.08);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <div style="padding:4px 8px; background: rgba(255, 159, 10, 0.2); border-radius:6px; display:flex; gap:6px; align-items:center;">
                                            <i class="ph-fill ph-bell" style="color: var(--orange); font-size: 14px;"></i>
                                            <span style="font-size:11px; color: #fb923c; font-weight:700; text-transform:uppercase;">AVVISO</span>
                                        </div>
                                        <div style="font-size:12px; color:var(--text-secondary); font-weight:600;">
                                            ${data} ‚Ä¢ ${autore}
                                        </div>
                                    </div>
                                    <div style="font-weight:700; font-size:17px; margin-bottom:8px; color: white; line-height:1.3;">${oggetto}</div>
                                    ${testo ? `<div style="font-size:14px; opacity:0.9; line-height:1.6; color: #cbd5e1; margin-bottom: ${url ? '8px' : '0'}; white-space: pre-wrap;">${testo}</div>` : ''}
                                    ${url ? `<a href="${url}" target="_blank" style="margin-top:12px; background:rgba(37, 99, 235, 0.2); padding:8px 12px; border-radius:8px; border:1px solid rgba(37, 99, 235, 0.3); color:#60a5fa; font-size:13px; display:inline-flex; align-items:center; gap:6px; font-weight:600; text-decoration:none;">
                                        <i class="ph ph-paperclip"></i> Apri Allegato <i class="ph-bold ph-arrow-up-right" style="font-size:10px;"></i>
                                    </a>` : ''}
                                </div>
                            `;
                    }).join('')
                }
                    </div>
                </div>
            </div>`;
        }

        function renderProfile() {
            return `
            <div class="view">
                <h1>Profilo</h1>
                <div style="margin-top:20px;">
                    <div class="card">
                        <div style="font-size: 14px; color:var(--text-secondary); margin-bottom:8px;">Utente Collegato</div>
                        <div style="font-size:18px; font-weight:700; margin-bottom:16px;">${state.user.name || 'Non specificato'}</div>
                        <div style="font-size:14px; color: var(--text-secondary); margin-bottom:12px;">Classe: ${state.user.class || 'Non specificata'}</div>
                        ${state.lastSync ? `<div style="font-size:12px; color: var(--text-secondary); display:flex; align-items:center; gap:6px;">
                            <i class="ph ph-clock" style="font-size:14px;"></i>
                            Ultima sincronizzazione: ${state.lastSync}
                        </div>` : ''}
                    </div>
                    <div class="card" style="margin-top:16px;">
                        <div style="font-size: 14px; color:var(--text-secondary); margin-bottom:12px; font-weight:600;">Stato Connessione</div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <div style="width:12px; height:12px; border-radius:50%; background:${state.didup.connected ? 'var(--green)' : 'var(--red)'};"></div>
                            <span>DidUP: ${state.didup.connected ? 'Connesso' : 'Non connesso'}</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:12px; height:12px; border-radius:50%; background:${state.isOffline ? 'var(--red)' : 'var(--green)'};"></div>
                            <span>Server: ${state.isOffline ? 'Offline' : 'Online'}</span>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="logout()" style="background:var(--red); margin-top:20px; cursor:pointer;">Esci e Disconnetti</button>
                    <button onclick="openArgoLogin()" style="background:var(--blue); width:100%; padding:16px; border-radius:14px; font-weight:600; font-size:16px; cursor:pointer; border:none; color:white; margin-top:12px;">
                        <i class="ph ph-arrow-clockwise"></i> Riconnetti DidUP
                    </button>
                </div>
            </div>`;
        }

        // --- CORE UI MODALS & ACTIONS ---

        function openNewPostModal() {
            modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <button onclick="closeModal()" style="background:none; border:none; color:var(--blue); cursor:pointer;">Annulla</button>
                        <b>Nuovo Post</b>
                        <button onclick="publishPost()" style="background:none; border:none; color:var(--blue); font-weight:700; cursor:pointer;">Pubblica</button>
                    </div>
                    <textarea id="new-post-text" rows="5" placeholder="Scrivi qualcosa..."></textarea>
                    
                    <div style="margin-bottom: 20px;">
                         <label style="display:flex; align-items:center; gap:10px; margin-bottom: 10px; cursor:pointer;">
                            <input type="checkbox" id="post-anon-toggle" style="width:20px; height:20px;">
                            <span>Pubblica in Anonimo</span>
                        </label>
                         <label style="display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.1); padding:10px; border-radius:12px; cursor:pointer;">
                            <i class="ph ph-camera" style="font-size:20px;"></i>
                            <span>Aggiungi Foto</span>
                            <input type="file" id="post-image-input" accept="image/*" style="display:none;" onchange="handleImagePreview(this)">
                        </label>
                        <div id="image-preview" style="margin-top:10px;"></div>
                    </div>
                </div>
            </div>`;
        }

        function openArgoLogin() {
            modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content" style="text-align:center;">
                    <div style="width:60px; height:60px; background:#106690; border-radius:16px; display:flex; align-items:center; justify-content:center; margin:0 auto 20px auto;">
                         <i class="ph-fill ph-book-bookmark" style="font-size:30px;"></i>
                    </div>
                    <h2 style="margin-bottom:8px;">Collega DidUP</h2>
                    
                    <!-- SERVER STATUS WIDGET -->
                    <div id="server-status" style="margin-bottom: 20px; font-size: 12px; color: var(--orange); display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span style="width: 8px; height: 8px; background: var(--orange); border-radius: 50%;"></span>
                        Sto cercando il server...
                    </div>

                    <input id="argo-school" placeholder="Codice Scuola (es. SG12345)">
                    <input id="argo-user" placeholder="Nome Utente">
                    <input type="password" id="argo-pass" placeholder="Password">
                    
                    <button id="login-btn" onclick="performArgoSync()" style="background:var(--blue); width:100%; padding: 14px; border-radius:12px; font-weight:700; margin-top:10px; border:none; color:white; cursor:pointer;">Accedi e Sincronizza</button>
                    <button onclick="closeModal()" style="background:none; width:100%; padding: 10px; margin-top:5px; border:none; color:var(--text-secondary); cursor:pointer;">Annulla</button>
                    <button onclick="testBackendConnection()" style="background:rgba(255,255,255,0.1); width:100%; padding: 10px; margin-top:5px; border:1px solid rgba(255,255,255,0.2); border-radius:12px; color:var(--text-secondary); cursor:pointer; font-size:12px;">üîç Test Connessione Backend</button>
                </div>
            </div>`;

            // AUTO-CHECK SERVER HEALTH
            checkServerHealth();
        }

        async function checkServerHealth(attempt = 1) {
            const statusEl = document.getElementById('server-status');
            if (!statusEl) return;

            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 3500);

                const res = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                clearTimeout(id);

                if (res.ok) {
                    statusEl.innerHTML = `<span style="width: 8px; height: 8px; background: var(--green); border-radius: 50%;"></span> Server Online`;
                    statusEl.style.color = "var(--green)";
                } else {
                    throw new Error("Server error");
                }
            } catch (e) {
                if (attempt < 15) {
                    statusEl.innerHTML = `<span style="width: 8px; height: 8px; background: var(--orange); border-radius: 50%;"></span> Sveglio il server (${attempt})...`;
                    setTimeout(() => checkServerHealth(attempt + 1), 2500);
                } else {
                    statusEl.innerHTML = `<span style="width: 8px; height: 8px; background: var(--red); border-radius: 50%;"></span> Offline (uso dati cached)`;
                    statusEl.style.color = "var(--red)";
                }
            }
        }

        function openNewItemModal() {
            modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <button onclick="closeModal()" style="background:none; border:none; color:var(--blue); cursor:pointer;">Annulla</button>
                        <b>Vendi Libro</b>
                        <button onclick="publishItem()" style="background:none; border:none; color:var(--green); font-weight:700; cursor:pointer;">Metti in vendita</button>
                    </div>
                    <input id="item-title" placeholder="Titolo Libro">
                    <input id="item-price" placeholder="Prezzo (es. 15‚Ç¨)">
                    
                    <label style="display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.1); padding:16px; border-radius:12px; cursor:pointer; margin-bottom:20px;">
                        <i class="ph ph-camera" style="font-size:24px;"></i>
                        <span>Scatta/Carica Foto</span>
                        <input type="file" id="item-image-input" accept="image/*" capture="environment" style="display:none;" onchange="handleImagePreview(this)">
                    </label>
                    <div id="image-preview" style="margin-top:10px;"></div>
                </div>
            </div>`;
        }

        function handleImagePreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('image-preview').innerHTML = `<img src="${e.target.result}" style="max-height:100px; border-radius:8px;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ‚≠ê Credenziali Temporanee (per sopravvivere alla modale se il DOM cambia)
        let tempCreds = { school: '', user: '', pass: '' };

        // ‚≠ê Funzione Globale di Selezione
        // ‚≠ê Funzione Globale di Selezione
        window.selectProfileGlobal = function (index, btnElement) {
            console.log("‚úÖ CLICK BUTTON PROFILO:", index);

            // 1. Disabilita TUTTI i bottoni nella modale per evitare doppi click
            const allBtns = document.querySelectorAll('.modal-content button');
            allBtns.forEach(b => {
                b.disabled = true;
                b.style.pointerEvents = 'none';
                b.style.opacity = '0.5';
            });

            // 2. Feedback visivo sul bottone cliccato
            if (btnElement) {
                btnElement.style.opacity = '1'; // Mantieni focus su questo
                btnElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:10px;"><i class="ph-bold ph-spinner ph-spin"></i> Caricamento Dati...</div>';
            }

            // 3. Procedi
            performArgoSync(index);
        }

        // ‚≠ê SELEZIONE PROFILO (Multi-Figlio)
        function showProfileSelectionModal(profiles) {
            console.log("üë• Mostro modale selezione profili:", profiles);

            modalContainer.innerHTML = `
            <div class="modal-overlay" style="z-index: 9999; animation: fadeIn 0.3s ease-out;">
                <div class="modal-content" style="max-width: 400px; padding: 0; background: var(--surface-color); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                    <div style="padding: 24px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <div style="width: 64px; height: 64px; background: rgba(10, 132, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i class="ph-fill ph-users" style="font-size: 32px; color: var(--blue);"></i>
                        </div>
                        <h2 style="font-size: 20px; margin-bottom: 8px;">Seleziona Profilo</h2>
                        <p style="font-size: 14px; color: var(--text-secondary); margin: 0;">Scegli quale studente visualizzare</p>
                    </div>
                    
                    <div style="padding: 24px; display: flex; flex-direction: column; gap: 12px; max-height: 50vh; overflow-y: auto;">
                        ${profiles.map(p => {
                // Fallback per nome vuoto
                const displayName = (p.name && p.name.trim().length > 0 && p.name !== " ") ? p.name : `Studente ${p.index + 1}`;
                return `
                        <button onclick="window.selectProfileGlobal(${p.index}, this)" 
                                style="background: var(--surface-highlight); border: 1px solid rgba(255,255,255,0.05); padding: 16px; border-radius: 16px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: all 0.2s; width: 100%; text-align: left; -webkit-tap-highlight-color: transparent;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--blue), var(--indigo)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: white; flex-shrink: 0;">
                                ${displayName.charAt(0)}
                            </div>
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; font-size: 16px; color: white; margin-bottom: 4px;">${displayName}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${p.school} ‚Ä¢ ${p.class}</div>
                            </div>
                            <i class="ph-bold ph-caret-right" style="color: var(--text-secondary);"></i>
                        </button>
                        `}).join('')}
                    </div>
                </div>
            </div>`;
        }

        async function performArgoSync(profileIndex = null) {
            const btn = document.getElementById('login-btn');

            // Tentativo lettura DOM
            const inputSchool = document.getElementById('argo-school');
            const inputUser = document.getElementById('argo-user');
            const inputPass = document.getElementById('argo-pass');

            let school = inputSchool ? inputSchool.value : tempCreds.school;
            let user = inputUser ? inputUser.value : tempCreds.user;
            let pass = inputPass ? inputPass.value : tempCreds.pass;

            // Aggiorna cache se abbiamo letto dal DOM
            if (inputSchool && inputUser && inputPass) {
                tempCreds = { school, user, pass };
            }

            if (!school || !user || !pass) {
                alert("Dati mancanti! Reinserisci le credenziali.");
                // Se mancano e non sono nel DOM, forse dobbiamo ricaricare la login view?
                if (!inputSchool) render();
                return;
            }

            if (btn) {
                btn.innerText = "Connessione... ";
                btn.disabled = true;
            }

            try {
                // Prepara payload
                const payload = {
                    schoolCode: school,
                    username: user,
                    password: pass
                };

                // Se abbiamo un indice profilo (o era salvato in sessione), mandiamolo
                if (profileIndex !== null) {
                    payload.profileIndex = profileIndex;
                } else {
                    // Controlla se c'√® un profilo salvato in sessione precedente
                    const savedSession = sessionManager.load();
                    if (savedSession && savedSession.profileIndex !== undefined) {
                        payload.profileIndex = savedSession.profileIndex;
                    }
                }

                // Timeout 60s per connessioni lente
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                // ‚≠ê GESTIONE MULTI-PROFILO
                if (response.ok && data.status === 'MULTIPLE_PROFILES') {
                    console.log("üë• Backend richiede selezione profilo");
                    showProfileSelectionModal(data.profiles);
                    // Reset pulsante login
                    btn.innerText = "Accedi";
                    btn.disabled = false;
                    return; // Stop qui, l'utente sceglier√†
                }

                if (!response.ok) {
                    throw new Error(data.error || "Errore Server");
                }

                if (data.success) {
                    console.log("‚úÖ Login OK, saving...");
                    console.log("üì• Dati ricevuti dal login:", {
                        tasks: data.tasks?.length || 0,
                        voti: data.voti?.length || 0,
                        promemoria: data.promemoria?.length || data.announcements?.length || 0,
                        student: data.student
                    });

                    // ‚≠ê CRITICO: Salva sessione con credenziali codificate (come nel codice vecchio che funzionava)
                    if (data.session) {
                        data.session.storedUser = btoa(unescape(encodeURIComponent(user)));
                        data.session.storedPass = btoa(unescape(encodeURIComponent(pass)));
                        data.session.schoolCode = school;
                        sessionManager.save(data.session);
                        console.log("üíæ Sessione salvata con credenziali");
                    } else {
                        // ‚≠ê Se non c'√® sessione dal backend, crea una con le credenziali
                        sessionManager.save({
                            schoolCode: school,
                            storedUser: btoa(unescape(encodeURIComponent(user))),
                            storedPass: btoa(unescape(encodeURIComponent(pass)))
                        });
                        console.log("üíæ Sessione minima creata con credenziali");
                    }

                    // ‚≠ê Salva user
                    if (data.student) {
                        state.user = data.student;
                        localStorage.setItem('argo_user', JSON.stringify(state.user));
                        console.log("üíæ User salvato:", state.user.name);
                    }

                    // ‚≠ê Carica compiti con updateTasks per preservare date
                    if (data.tasks && data.tasks.length > 0) {
                        updateTasks(data.tasks, false);
                        console.log("‚úÖ Compiti caricati:", state.tasks.length);
                    }

                    // ‚≠ê CRITICO: Carica voti e salva SEMPRE
                    console.log("üéì LOGIN - Controllo voti in data:", data);
                    console.log("üéì LOGIN - data.voti:", data.voti);
                    console.log("üéì LOGIN - typeof data.voti:", typeof data.voti);
                    console.log("üéì LOGIN - Array.isArray(data.voti):", Array.isArray(data.voti));

                    if (data.voti !== undefined) {
                        state.voti = Array.isArray(data.voti) ? data.voti : [];
                        localStorage.setItem('argo_voti', JSON.stringify(state.voti));
                        console.log("‚úÖ Voti caricati e salvati:", state.voti.length);
                        console.log("‚úÖ Voti salvati - contenuto completo:", JSON.stringify(state.voti));
                        if (state.voti.length === 0) {
                            console.warn("‚ö†Ô∏è ATTENZIONE: Array voti vuoto - il backend NON sta recuperando i voti da DidUP");
                        } else {
                            console.log("‚úÖ Primo voto esempio:", state.voti[0]);
                        }
                    } else {
                        console.error("‚ùå ERRORE CRITICO: Campo 'voti' non presente nella risposta del login!");
                        console.error("‚ùå Chiavi disponibili in data:", Object.keys(data));
                        console.error("‚ùå Risposta completa:", data);
                    }

                    // ‚≠ê CRITICO: Carica promemoria e salva SEMPRE
                    const promemoriaData = data.promemoria || data.announcements;
                    if (promemoriaData !== undefined) {
                        state.promemoria = Array.isArray(promemoriaData) ? promemoriaData : [];
                        localStorage.setItem('argo_promemoria', JSON.stringify(state.promemoria));
                        console.log("‚úÖ Promemoria caricati e salvati:", state.promemoria.length);
                        if (state.promemoria.length === 0) {
                            console.warn("‚ö†Ô∏è ATTENZIONE: Array promemoria vuoto - il backend NON sta recuperando i promemoria da DidUP");
                        }
                    } else {
                        console.warn("‚ö†Ô∏è ATTENZIONE: Campo 'promemoria'/'announcements' non presente nella risposta del login");
                    }

                    state.isLoggedIn = true;
                    state.didup.connected = true;
                    state.isOffline = false;
                    state.lastSync = new Date().toLocaleTimeString();
                    updateOfflineBadge();

                    closeModal();
                    alert(`‚úÖ Benvenuto ${data.student?.name || user}! Dati sincronizzati.`);
                    render();
                } else {
                    alert("‚ùå Credenziali errate: " + (data.error || "Errore sconosciuto"));
                    console.error("‚ùå Login fallito:", data);
                }
            } catch (e) {
                console.error("‚ùå Errore Login:", e);
                if (e.name === 'AbortError') {
                    alert("‚ö†Ô∏è Tempo scaduto! La connessione a DidUP √® lenta o instabile. Riprova.");
                } else {
                    alert("‚ùå Errore durante il login: " + e.message);
                }
                // Riabilita bottoni modale se presente
                const allBtns = document.querySelectorAll('.modal-content button');
                allBtns.forEach(b => {
                    b.disabled = false;
                    b.style.pointerEvents = 'auto';
                    b.style.opacity = '1';
                });
            } finally {
                if (btn) {
                    btn.innerText = "Accedi";
                    btn.disabled = false;
                }
            }
        }

        async function publishPost() {
            const text = document.getElementById('new-post-text').value;
            const isAnon = document.getElementById('post-anon-toggle').checked;
            const imgPreview = document.querySelector('#image-preview img');

            if (text) {
                const newPost = {
                    id: Date.now(),
                    author: isAnon ? "Studente" : (state.user.name || "Utente"),
                    class: isAnon ? "5B" : (state.user.class || "5B"),
                    text: text,
                    likes: 0,
                    liked: false,
                    anon: isAnon,
                    image: imgPreview ? imgPreview.src : null,
                    comments: []
                };
                await submitPost(newPost);
                closeModal();
                render();
            }
        }

        async function publishItem() {
            const title = document.getElementById('item-title').value;
            const price = document.getElementById('item-price').value;
            const imgPreview = document.querySelector('#image-preview img');

            if (title && price) {
                const newItem = {
                    id: Date.now(),
                    title: title,
                    price: price,
                    image: imgPreview ? imgPreview.src : null,
                    seller: state.user.name || "Utente"
                };
                await submitItem(newItem);
                closeModal();
                render();
            }
        }

        function toggleLike(id) {
            const p = state.posts.find(x => x.id === id);
            if (p) {
                p.liked = !p.liked;
                p.likes += p.liked ? 1 : -1;
                render();
            }
        }

        function closeModal(e) {
            if (!e || e.target.classList.contains('modal-overlay')) {
                modalContainer.innerHTML = '';
            }
        }

        function openChat(u) {
            state.currentChatUser = u;
            if (!state.messages[u]) state.messages[u] = [];
            navigate('chat');
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const txt = input.value;
            if (txt) {
                state.messages[state.currentChatUser].push({ text: txt, me: true });
                input.value = '';
                render();
                setTimeout(() => {
                    const history = document.getElementById('chat-history');
                    if (history) history.scrollTop = history.scrollHeight;
                }, 10);
            }
        }

        function toggleTask(id) {
            let t = state.tasks.find(x => x.id === id);
            if (!t) t = state.reminders.find(x => x.id === id);

            if (t) {
                t.done = !t.done;
                saveTasks();
                if (state.reminders.find(x => x.id === id)) {
                    localStorage.setItem('argo_reminders', JSON.stringify(state.reminders));
                }
                render();
            }
        }

        function addManualReminder() {
            const text = prompt("Cosa devi fare? (es. Compito Mate per il 20/01)");
            if (text) {
                state.reminders.push({
                    id: Date.now(),
                    text: text,
                    done: false
                });
                localStorage.setItem('argo_reminders', JSON.stringify(state.reminders));
                render();
            }
        }

        function updateFeedSearch(value) {
            state.feed.search = value;
            render();
        }

        function setFeedClass(c) {
            state.feed.classFilter = c;
            render();
        }
        function showSearchModal() {
            modalContainer.innerHTML = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal-content glass-panel" style="max-width: 400px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin:0;">Cerca</h2>
                            <i class="ph ph-x" onclick="closeModal()" style="cursor:pointer; font-size: 24px;"></i>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none;">
                            <div onclick="setSearchFilter('tutti')" id="filter-tutti" class="search-filter-pill active">Tutti</div>
                            <div onclick="setSearchFilter('alunni')" id="filter-alunni" class="search-filter-pill">Alunni</div>
                            <div onclick="setSearchFilter('professori')" id="filter-professori" class="search-filter-pill">Professori</div>
                            <div onclick="setSearchFilter('materie')" id="filter-materie" class="search-filter-pill">Materie</div>
                        </div>

                        <div class="search-bar" style="margin-bottom: 20px; background: rgba(255,255,255,0.1);">
                            <i class="ph-bold ph-magnifying-glass"></i>
                            <input type="text" id="global-search-input" placeholder="Cerca..." oninput="performGlobalSearch(this.value)" style="background: transparent; border: none; color: white; width: 100%; padding: 8px;">
                        </div>

                        <div id="search-results" style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;">
                            <div style="text-align: center; opacity: 0.5; padding: 20px;">Inizia a scrivere per cercare...</div>
                        </div>
                    </div>
                </div>
            `;
            state.activeSearchFilter = 'tutti';
        }

        function setSearchFilter(f) {
            state.activeSearchFilter = f;
            document.querySelectorAll('.search-filter-pill').forEach(p => p.classList.remove('active'));
            document.getElementById(`filter-${f}`).classList.add('active');
            performGlobalSearch(document.getElementById('global-search-input').value);
        }

        function performGlobalSearch(q) {
            const resultsEl = document.getElementById('search-results');
            if (!q || q.length < 2) {
                resultsEl.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">Inizia a scrivere per cercare...</div>';
                return;
            }

            let results = [];
            const query = q.toLowerCase();

            if (state.activeSearchFilter === 'tutti' || state.activeSearchFilter === 'alunni' || state.activeSearchFilter === 'professori') {
                const dirResults = DIRECTORY.filter(person => {
                    if (state.activeSearchFilter === 'alunni' && person.class === 'Docente') return false;
                    if (state.activeSearchFilter === 'professori' && person.class !== 'Docente') return false;
                    return person.name.toLowerCase().includes(query);
                });
                results = results.concat(dirResults.map(p => ({ type: 'person', ...p })));
            }

            if (state.activeSearchFilter === 'tutti' || state.activeSearchFilter === 'materie') {
                const taskResults = state.tasks.filter(t => t.subject.toLowerCase().includes(query) || t.text.toLowerCase().includes(query));
                results = results.concat(taskResults.map(t => ({ type: 'task', ...t })));
            }

            if (results.length === 0) {
                resultsEl.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">Nessun risultato trovato</div>';
                return;
            }

            resultsEl.innerHTML = results.map(r => {
                if (r.type === 'person') {
                    return `
                        <div class="glass-list-item" style="margin-bottom: 0; display: flex; align-items: center; gap: 12px;">
                            <div style="width: 36px; height: 36px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">${r.name[0]}</div>
                            <div>
                                <div style="font-weight: 600;">${r.name}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${r.class}</div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="glass-list-item" style="margin-bottom: 0;">
                            <div style="font-size: 11px; color: var(--blue); font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">${r.subject}</div>
                            <div style="font-weight: 500;">${r.text}</div>
                            <div style="font-size: 10px; color: var(--orange); margin-top: 4px;">Scadenza: ${r.due_date}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        function showStressModal() {
            const todayStr = new Date().toISOString().split('T')[0];
            const currentLevel = state.stressLevels[todayStr] || 0;

            modalContainer.innerHTML = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal-content glass-panel" style="max-width: 400px; padding: 24px; text-align: center;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin:0;">Stress Giornaliero</h2>
                            <i class="ph ph-x" onclick="closeModal()" style="cursor:pointer; font-size: 24px;"></i>
                        </div>
                        <p style="opacity: 0.7; margin-bottom: 24px;">Come ti senti oggi? Registrare il tuo livello di stress ci aiuta a ottimizzare il tuo planner.</p>
                        
                        <div style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 30px;">
                            ${[1, 2, 3, 4, 5].map(lv => {
                const colors = ['', '#4ade80', '#fbbf24', '#f87171', '#ef4444', '#7f1d1d'];
                const color = colors[lv];
                const isActive = currentLevel === lv;
                return `
                                    <div onclick="setStressLevel(${lv})" style="flex: 1; aspect-ratio: 1; border-radius: 12px; background: ${isActive ? color : 'rgba(255,255,255,0.05)'}; border: 1px solid ${isActive ? color : 'rgba(255,255,255,0.1)'}; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; transform: ${isActive ? 'scale(1.1)' : 'scale(1)'};">
                                        <span style="font-size: 20px; font-weight: 800; color: ${isActive ? 'white' : 'rgba(255,255,255,0.3)'};">${lv}</span>
                                    </div>
                                `;
            }).join('')}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; opacity: 0.5;">
                            <div style="text-align: left;"><i class="ph ph-leaf"></i> Rilassato</div>
                            <div style="text-align: right;">Esaurito <i class="ph ph-fire"></i></div>
                        </div>

                        <button onclick="closeModal()" class="btn-primary" style="margin-top: 24px;">Conferma</button>
                    </div>
                </div>
            `;
        }

        function setStressLevel(lv) {
            const todayStr = new Date().toISOString().split('T')[0];
            state.stressLevels[todayStr] = lv;
            saveTasks();
            render();
            showStressModal(); // Refresh modal
        }

        function showOrganizeStudyModal() {
            const todayStr = new Date().toISOString().split('T')[0];
            const plannedIds = state.plannedTasks[todayStr] || [];

            // Show ALL pending tasks (not just today's)
            const allPendingTasks = state.tasks.filter(t => !t.done);

            modalContainer.innerHTML = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal-content glass-panel" style="max-width: 450px; padding: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h2 style="margin:0; font-size: 24px;">Cosa fai oggi?</h2>
                            <i class="ph ph-x" onclick="closeModal()" style="cursor:pointer; font-size: 28px; opacity: 0.6;"></i>
                        </div>
                        <p style="font-size: 15px; opacity: 0.8; margin-bottom: 24px; line-height: 1.5;">Seleziona dalla lista i compiti che vuoi affrontare oggi. Verranno aggiunti alla tua agenda giornaliera.</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 30px; max-height: 450px; overflow-y: auto; padding-right: 8px;">
                            ${allPendingTasks.length > 0 ? allPendingTasks.map(t => {
                const isPlanned = plannedIds.includes(t.id);
                const subjectColor = getSubjectColor(t.subject);
                return `
                                    <div class="glass-list-item" style="margin-bottom: 0; padding: 18px; display: flex; align-items: center; gap: 16px; cursor: pointer; border-left: 4px solid ${isPlanned ? 'var(--green)' : 'rgba(255,255,255,0.05)'}; background: ${isPlanned ? 'rgba(48, 209, 88, 0.08)' : 'rgba(255,255,255,0.03)'};" onclick="togglePlanTask('${t.id}')">
                                        <div style="width: 28px; height: 28px; border-radius: 8px; background: ${isPlanned ? 'var(--green)' : 'transparent'}; border: 2px solid ${isPlanned ? 'var(--green)' : 'rgba(255,255,255,0.2)'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s;">
                                            ${isPlanned ? '<i class="ph-bold ph-check" style="font-size: 16px; color: black;"></i>' : ''}
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 700; font-size: 16px; color: white; margin-bottom: 4px; line-height: 1.3;">${t.text}</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                                <div style="font-size: 12px; color: ${subjectColor}; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">${t.subject}</div>
                                                <div style="font-size: 11px; opacity: 0.5; font-weight: 600;">Scade: ${t.display_date}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
            }).join('') : '<div style="text-align: center; opacity: 0.5; padding: 40px;">Non ci sono compiti in sospeso. Ottimo lavoro!</div>'}
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeModal()" class="btn-primary" style="flex: 1; padding: 16px; font-size: 16px; font-weight: 700;">Salva Agenda</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showTasksBySubjectModal() {
            const subjects = [...new Set(state.tasks.map(t => t.subject))].sort();

            modalContainer.innerHTML = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal-content glass-panel" style="max-width: 500px; padding: 24px; max-height: 85vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; position: sticky; top: 0; background: rgba(30,30,30,0.8); backdrop-filter: blur(10px); padding: 10px; border-radius: 12px; z-index: 5;">
                            <h2 style="margin:0;">Compiti per Materia</h2>
                            <i class="ph ph-x" onclick="closeModal()" style="cursor:pointer; font-size: 24px;"></i>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            ${subjects.map(s => {
                const subjectTasks = state.tasks.filter(t => t.subject === s);
                const color = getSubjectColor(s);
                return `
                                    <div style="border-left: 4px solid ${color}; padding-left: 16px;">
                                        <h3 style="color: ${color}; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                            <i class="ph-fill ph-book-open"></i>
                                            ${s}
                                            <span style="background: ${color}20; color: ${color}; font-size: 10px; padding: 2px 8px; border-radius: 20px; font-weight: 800; border: 1px solid ${color}40;">
                                                ${subjectTasks.length}
                                            </span>
                                        </h3>
                                        <div style="display: flex; flex-direction: column; gap: 10px;">
                                            ${subjectTasks.map(t => `
                                                <div class="glass-list-item" style="margin-bottom: 0; background: rgba(255,255,255,0.03); padding: 12px; display: flex; align-items: center; gap: 12px;">
                                                    <div onclick="toggleTask('${t.id}')" style="width: 18px; height: 18px; border: 2px solid ${t.done ? 'var(--green)' : 'rgba(255,255,255,0.2)'}; background: ${t.done ? 'var(--green)' : 'transparent'}; border-radius: 5px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                        ${t.done ? '<i class="ph-bold ph-check" style="font-size: 10px; color: black;"></i>' : ''}
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 14px; font-weight: 600; color: white; ${t.done ? 'opacity: 0.5; text-decoration: line-through;' : ''}">${t.text}</div>
                                                        <div style="font-size: 10px; opacity: 0.5; margin-top: 2px;">Data: ${t.display_date}</div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                        
                        <button onclick="closeModal()" class="btn-primary" style="margin-top: 30px;">Chiudi</button>
                    </div>
                </div>
            `;
        }

        function togglePlanTask(id) {
            const todayStr = new Date().toISOString().split('T')[0];
            if (!state.plannedTasks[todayStr]) state.plannedTasks[todayStr] = [];

            const index = state.plannedTasks[todayStr].indexOf(id);
            if (index > -1) {
                state.plannedTasks[todayStr].splice(index, 1);
            } else {
                state.plannedTasks[todayStr].push(id);
            }

            saveTasks();
            // ‚≠ê Solo refresh modal, NO render() per evitare scatti
            showOrganizeStudyModal();
        }

        function startStudySession() {
            const duration = prompt("Quanti minuti vuoi studiare?", "25");
            if (duration && !isNaN(duration)) {
                // For now simple alert, can be expanded to a real visible timer later
                alert(`‚è±Ô∏è Sessione di studio avviata per ${duration} minuti!\n\nConcentrati e metti via il telefono.`);

                setTimeout(() => {
                    alert("‚è∞ DING! Sessione finita. Prenditi una pausa!");
                }, duration * 60 * 1000);
            }
        }

        // ‚≠ê Funzione di test per verificare la connessione backend
        async function testBackendConnection() {
            const statusEl = document.getElementById('server-status');
            if (statusEl) {
                statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: var(--orange); border-radius: 50%;"></span> Test in corso...';
                statusEl.style.color = "var(--orange)";
            }

            try {
                console.log("üîç Test connessione backend...");

                // Test 1: Health check
                const healthRes = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                console.log("‚úÖ Health check:", healthRes.status, healthRes.ok);

                // Test 2: Verifica formato risposta (se disponibile)
                if (healthRes.ok) {
                    const healthData = await healthRes.json().catch(() => ({}));
                    console.log("üìã Health response:", healthData);
                }

                if (statusEl) {
                    statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: var(--green); border-radius: 50%;"></span> Backend raggiungibile';
                    statusEl.style.color = "var(--green)";
                }

                alert("‚úÖ Backend raggiungibile! Controlla la console per i dettagli.");
            } catch (e) {
                console.error("‚ùå Test fallito:", e);
                if (statusEl) {
                    statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: var(--red); border-radius: 50%;"></span> Backend non raggiungibile';
                    statusEl.style.color = "var(--red)";
                }
                alert("‚ùå Backend non raggiungibile: " + e.message + "\n\nVerifica:\n- URL backend corretto: " + API_BASE_URL + "\n- Server online\n- CORS configurato");
            }
        }

        // Init - render will be called by DOMContentLoaded
        function renderPollWidget() {
            return `
            <div class="card glass-panel" style="padding-bottom: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                    <span style="color: var(--purple); font-size: 12px; font-weight: 700; text-transform: uppercase;">Sondaggio Community</span>
                    <span style="font-size: 12px; color: var(--text-secondary);">Scade tra 5h</span>
                </div>
                <h3 style="margin-bottom: 20px; font-size: 18px; line-height: 1.4; color: white; text-align: left;">Data prossima Assemblea? üóìÔ∏è</h3>
                
                <div onclick="this.style.background='var(--blue)'; this.style.borderColor='var(--blue)'" style="padding: 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; margin-bottom: 10px; font-weight: 600; display: flex; justify-content: space-between; cursor:pointer; color: white;">
                    <span>Venerd√¨ 7 Feb</span>
                    <span>60%</span>
                </div>
                    <div onclick="this.style.background='var(--blue)'; this.style.borderColor='var(--blue)'" style="padding: 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; margin-bottom: 10px; font-weight: 600; display: flex; justify-content: space-between; cursor:pointer; color: white;">
                    <span>Luned√¨ 10 Feb</span>
                    <span>15%</span>
                </div>
                    <div onclick="this.style.background='var(--blue)'; this.style.borderColor='var(--blue)'" style="padding: 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; font-weight: 600; display: flex; justify-content: space-between; cursor:pointer; color: white;">
                    <span>Sabato 15 Feb</span>
                    <span>25%</span>
                </div>
            </div>`;
        }
    </script>
</body>

</html>

</html>