from flask import Flask, request, jsonify
from flask_cors import CORS
import argofamiglia
import uuid
import datetime
import os

app = Flask(__name__)

# Simplified CORS for Token Bridge (No credentials needed in body-based approach)
CORS(app, origins=[
    "https://*.netlify.app",
    "http://127.0.0.1:*",
    "http://localhost:*",
    "*" # Allow all for debugging, restrict later
])

class ArgoTokenAuth(argofamiglia.ArgoFamiglia):
    def __init__(self, school_code, auth_token, access_token):
        # We set ALL internal attributes to ensure base class methods work correctly
        self._ArgoFamiglia__school = school_code
        self._ArgoFamiglia__username = "SessionUser"
        self._ArgoFamiglia__token = auth_token
        self._ArgoFamiglia__login_data = {"access_token": access_token}
        
        # Manually reconstruct headers used by dashboard() and getCompitiByDate()
        self._ArgoFamiglia__headers = {
            "Content-Type": "Application/json",
            "Authorization": "Bearer " + access_token,
            "Accept": "Application/json",
            "x-cod-min": school_code,
            "x-auth-token": auth_token
        }
        
    def connect(self):
        # Already connected via tokens
        pass

@app.route('/health', methods=['GET'])
def health():
    return jsonify({"status": "ok"}), 200

@app.route('/login', methods=['POST'])
def login():
    data = request.json
    school_code = data.get('schoolCode')
    username = data.get('username')
    password = data.get('password')

    if not all([school_code, username, password]):
        return jsonify({"success": False, "error": "Credenziali mancanti"}), 400

    try:
        print(f"üîê Login attempt: {username}@{school_code}")
        
        # Authenticate with Argo
        argo = argofamiglia.ArgoFamiglia(school_code, username, password)
        
        # EXTRACT TOKENS (Private attributes access)
        auth_token = argo._ArgoFamiglia__headers.get('x-auth-token')
        access_token = argo._ArgoFamiglia__headers.get('Authorization').replace("Bearer ", "")
        
        # Fetch initial data
        raw_response = argo.getCompitiByDate()
        tasks_data = parse_tasks(raw_response)
        
        print(f"‚úÖ Login success. Returning tokens to client.")
        
        return jsonify({
            "success": True,
            "session": {
                "schoolCode": school_code,
                "authToken": auth_token,
                "accessToken": access_token,
                "userName": username
            },
            "student": { "name": username, "class": "DidUP", "school": school_code },
            "tasks": tasks_data
        }), 200

    except Exception as e:
        print(f"‚ùå Login failed: {e}")
        return jsonify({"success": False, "error": str(e)}), 401

@app.route('/sync', methods=['POST'])
def sync_data():
    """Sync using tokens provided in the request body (Stateless)"""
    data = request.json
    school = data.get('schoolCode')
    auth_token = data.get('authToken')
    access_token = data.get('accessToken')
    
    if not all([school, auth_token, access_token]):
        return jsonify({"success": False, "error": "Token di sessione mancanti"}), 401
    
    try:
        print(f"üîÑ Stateless sync for school {school}...")
        
        # Re-hydrate session using tokens
        argo = ArgoTokenAuth(school, auth_token, access_token)
        
        # Fetch data
        raw_response = argo.getCompitiByDate()
        tasks_data = parse_tasks(raw_response)
        
        return jsonify({
            "success": True,
            "tasks": tasks_data
        }), 200
        
    except Exception as e:
        import traceback
        print(f"‚ùå Sync failed for {school}: {e}")
        traceback.print_exc()
        return jsonify({"success": False, "error": str(e)}), 401

@app.route('/web/<path:path>')
def serve_web(path):
    return send_from_directory('web', path)

@app.route('/')
def index():
    try:
        from flask import send_from_directory
        return send_from_directory('web', 'index.html')
    except:
        return "G-Connect Server is running. Please open the frontend."

def parse_tasks(raw_response):
    tasks_data = [] 
    if isinstance(raw_response, dict):
         for date_str, details in raw_response.items():
             compiti_list = details.get('compiti', [])
             materie_list = details.get('materie', [])
             for i, desc in enumerate(compiti_list):
                 mat = materie_list[i] if i < len(materie_list) else "Materia"
                 tasks_data.append({
                    "id": str(date_str) + str(uuid.uuid4())[:8], 
                    "text": f"{mat}: {desc}",
                    "done": False,
                    "date": date_str
                 })
    return tasks_data

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 5002))
    print(f"üöÄ G-Connect Server running on port {port}")
    app.run(host='0.0.0.0', port=port, debug=True)

<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G-Connect</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link
        href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-color: #000000;
            --surface-color: #1C1C1E;
            --surface-highlight: #2C2C2E;
            --blue: #0A84FF;
            --purple: #BF5AF2;
            --indigo: #5E5CE6;
            --pink: #FF375F;
            --red: #FF453A;
            --orange: #FF9F0A;
            --yellow: #FFD60A;
            --green: #30D158;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --radius-L: 24px;
            --radius-M: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            font-family: 'SF Pro Display', 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            overflow: hidden;
            width: 100vw;
            height: 100dvh;
        }

        #app {
            height: 100%;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 120px;
            scroll-behavior: smooth;
        }

        #app::-webkit-scrollbar {
            display: none;
        }

        #app {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .view {
            padding: 24px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            margin: 0;
            letter-spacing: 0.3px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card {
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-L);
            padding: 20px;
            margin-bottom: 16px;
        }

        #bottom-nav {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            padding: 0 30px;
            height: 72px;
            background: rgba(25, 25, 25, 0.9);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 32px;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            z-index: 999;
        }

        .nav-item {
            background: none;
            border: none;
            padding: 0;
            color: rgba(255, 255, 255, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-item i {
            font-size: 28px;
        }

        .nav-item.active {
            color: white;
            transform: translateY(-2px);
        }

        .nav-item.active i {
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 20px;
            margin-bottom: 8px;
            max-width: 80%;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .msg-me {
            background: var(--blue);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .msg-other {
            background: var(--surface-highlight);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        input,
        textarea {
            width: 100%;
            background: var(--surface-highlight);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 14px;
            font-size: 16px;
            border-radius: 12px;
            font-family: inherit;
            resize: none;
            margin-bottom: 10px;
        }

        .search-container {
            position: sticky;
            top: -1px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 10px 0;
            margin: 0 -24px 20px -24px;
            padding: 10px 24px;
        }

        .btn-primary {
            background: var(--blue);
            color: white;
            width: 100%;
            border: none;
            padding: 16px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
        }

        .offline-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 159, 10, 0.1);
            border: 1px solid var(--orange);
            color: var(--orange);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1000;
            display: none;
        }

        .offline-badge.show {
            display: block;
        }
    </style>
</head>

<body>
    <div id="app"></div>
    <div id="modals"></div>
    <div id="offline-badge" class="offline-badge">üì° Offline Mode</div>

    <nav id="bottom-nav">
        <button class="nav-item active" onclick="navigate('home')"><i class="ph-fill ph-house"></i></button>
        <button class="nav-item" onclick="navigate('market')"><i class="ph-fill ph-bag"></i></button>
        <button class="nav-item" onclick="navigate('feed')"><i class="ph-fill ph-chats-circle"></i></button>
        <button class="nav-item" onclick="navigate('planner')"><i class="ph-fill ph-calendar-check"></i></button>
        <button class="nav-item" onclick="navigate('profile')"><i class="ph-fill ph-user"></i></button>
    </nav>

    <script>
        const DIRECTORY = [
            { name: 'Alessandro Russo', class: '5B', status: 'online' },
            { name: 'Sofia Bianchi', class: '3A', status: 'offline' },
            { name: 'Luca Esposito', class: '4C', status: 'online' },
            { name: 'Giulia Conti', class: '5B', status: 'offline' },
            { name: 'Matteo Ferri', class: '2A', status: 'online' },
            { name: 'Chiara Romano', class: '1B', status: 'offline' },
            { name: 'Proff. Esposito', class: 'Docente', status: 'online' }
        ];

        // ---------------------------------------------
        // ‚öôÔ∏è CONFIGURATION
        // Lascia vuoto ("") se il server √® locale o se index.html √® servito da Flask.
        // Inserisci l'URL di Render (es: "https://g-connect-backend.onrender.com") se deploy su Netlify.
        const API_BASE_URL = "https://g-connect-backend.onrender.com";
        // ---------------------------------------------
        // üÜï PERSISTENT SESSION MANAGER
        const sessionManager = {
            save(sessionData) {
                try {
                    localStorage.setItem('argo_session', JSON.stringify(sessionData));
                    localStorage.setItem('argo_is_logged_in', 'true');
                    console.log("‚úÖ Sessione salvata");
                } catch (e) {
                    console.error("‚ùå Errore salvataggio sessione:", e);
                    alert("Errore salvataggio dati locali. Prova a disabilitare modalit√† incognito.");
                }
            },
            load() {
                try {
                    const saved = localStorage.getItem('argo_session');
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    console.error("‚ùå Errore caricamento sessione:", e);
                    return null;
                }
            },
            isLoggedIn() {
                return localStorage.getItem('argo_is_logged_in') === 'true';
            },
            clear() {
                localStorage.removeItem('argo_session');
                localStorage.removeItem('argo_tasks');
                localStorage.removeItem('argo_is_logged_in');
                localStorage.removeItem('argo_user'); // ‚≠ê Per persistere user
                console.log("üóëÔ∏è Sessione cancellata");
            }
        };

        // STATE MANAGEMENT
        const state = {
            view: 'login',
            user: { name: 'Andrea', class: '5B' }, // ‚≠ê Verr√† sovrascritto da localStorage
            isLoggedIn: false,
            isOffline: false,
            feed: { search: '', classFilter: 'Tutte' },
            tasks: [], // ‚≠ê Inizializza vuoto, carica da localStorage
            posts: [
                { id: 1, author: 'Marco Rossi', class: '4A', text: 'Ragazzi chi ha gli appunti di filosofia?', likes: 4, liked: false, comments: [], image: null, anon: false },
                { id: 2, author: 'Rappresentanti', class: 'Istituto', text: '‚ö†Ô∏è Assemlea di Istituto confermata per Venerd√¨ in Aula Magna. ', likes: 89, liked: true, comments: [], image: null, anon: false }
            ],
            marketItems: [
                { id: 1, title: 'Matematica Blu Vol.3', price: '15‚Ç¨', image: 'https://m.media-amazon.com/images/I/71s+3sDQPIL._AC_UF1000,1000_QL80_. jpg', seller: 'Luca E.' },
                { id: 2, title: 'Divina Commedia', price: '10‚Ç¨', image: null, seller: 'Sofia B.' }
            ],
            messages: { 'Alessandro Russo': [{ text: 'Ciao Andrea! ', me: false }] },
            news: [
                { id: 128, title: 'Circolare n.  128 - Assemblea d\'Istituto 7 Febbraio', date: 'OGGI', url: 'https://www.liceogandhi.edu.it/categoria/storico-circolari/' },
                { id: 127, title: 'Circolare n. 127 - Variazione Calendario Scrutini', date: 'IERI', url: 'https://www.liceogandhi.edu.it/categoria/storico-circolari/' },
                { id: 126, title: 'Circolare n. 126 - Saldo viaggio d\'istruzione', date: '2 GG FA', url: 'https://www.liceogandhi.edu.it/categoria/storico-circolari/' }
            ]
        };

        const app = document.getElementById('app');
        const modalContainer = document.getElementById('modals');
        const offlineBadge = document.getElementById('offline-badge');

        // ‚≠ê INITIALIZE APP ON LOAD
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üöÄ App Loading...");
            const isLoggedIn = sessionManager.isLoggedIn();
            const savedSession = sessionManager.load();

            if (isLoggedIn && savedSession) {
                console.log("‚úÖ Sessione valida trovata!");
                // ‚≠ê Carica tasks con done persistito
                const cachedTasks = localStorage.getItem('argo_tasks');
                if (cachedTasks) {
                    try {
                        state.tasks = JSON.parse(cachedTasks); // ‚≠ê Mantiene done
                        console.log("üì¶ Compiti caricati con stato done:", state.tasks.length);
                    } catch (e) {
                        console.error("Errore cache tasks:", e);
                        state.tasks = [];
                    }
                }
                // ‚≠ê Carica user da localStorage
                const cachedUser = localStorage.getItem('argo_user');
                if (cachedUser) {
                    state.user = JSON.parse(cachedUser);
                } else if (savedSession.student) {
                    state.user = savedSession.student;
                    localStorage.setItem('argo_user', JSON.stringify(state.user));
                }
                state.isLoggedIn = true;
                state.view = 'home';
                render();

                // Sync in background
                console.log("üîÑ Sincronizzazione in background...");
                await performSync(savedSession); // ‚≠ê Await per completamento
            } else {
                console.log("‚ùå No session - showing login");
                state.isLoggedIn = false;
                state.view = 'login';
                render();
            }
        });

        function updateOfflineBadge() {
            if (state.isOffline) {
                offlineBadge.classList.add('show');
            } else {
                offlineBadge.classList.remove('show');
            }
        }

        async function performSync(sessionData) {
            if (!sessionData) sessionData = sessionManager.load();
            if (!sessionData) return;

            try {
                const response = await fetch(`${API_BASE_URL}/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);

                const data = await response.json();

                if (data.success && data.tasks) {
                    if (data.tasks.length === 0 && state.tasks.length > 0) {
                        // Se il server dice 'zero compiti' ma noi ne abbiamo salvati, 
                        // ignoriamo il server per evitare che spariscano dal display.
                        console.warn("‚ö†Ô∏è Il server ha mandato 0 compiti. Mantengo quelli locali per sicurezza.");
                        state.isOffline = false;
                        updateOfflineBadge();
                        render();
                        return;
                    }

                    updateTasks(data.tasks, true);
                    state.isOffline = false;
                    updateOfflineBadge();
                    console.log("‚úÖ Sync completato con successo!");
                    render();
                } else {
                    throw new Error("Sessione non valida");
                }
            } catch (e) {
                console.error("‚ö†Ô∏è Errore Sync:", e);
                if (e.message.includes("Sessione non valida")) {
                    if (sessionData && sessionData.storedUser && sessionData.storedPass) {
                        await performSilentLogin(sessionData.schoolCode, sessionData.storedUser, sessionData.storedPass);
                    } else {
                        sessionManager.clear();
                        state.isLoggedIn = false;
                        state.view = 'login';
                        alert("‚ùå Sessione scaduta. Effettua di nuovo il login.");
                        render();
                    }
                } else {
                    state.isOffline = true;
                    updateOfflineBadge();
                    render();
                }
            }
        }

        async function performSilentLogin(school, encodedUser, encodedPass) {
            try {
                const user = decodeURIComponent(escape(atob(encodedUser)));
                const pass = decodeURIComponent(escape(atob(encodedPass)));

                console.log("üîê Silent Login in corso...");

                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schoolCode: school, username: user, password: pass })
                });

                const data = await response.json();

                if (data.success) {
                    console.log("‚úÖ Silent Login riuscito!");

                    const newSession = {
                        ...data.session,
                        storedUser: encodedUser,
                        storedPass: encodedPass,
                        schoolCode: school
                    };
                    sessionManager.save(newSession);

                    if (data.tasks) updateTasks(data.tasks, true);
                    if (data.student) state.user = data.student;

                    state.isOffline = false;
                    updateOfflineBadge();
                    render();
                } else {
                    throw new Error("Silent login fallito");
                }
            } catch (e) {
                console.error("‚ùå Silent login errore:", e);
                state.isOffline = true;
                updateOfflineBadge();
            }
        }

        function saveTasks() {
            try {
                localStorage.setItem('argo_tasks', JSON.stringify(state.tasks));
                console.log("üíæ Compiti salvati con stato done");
            } catch (e) {
                console.error("‚ùå Errore salvataggio tasks:", e);
                alert("Errore salvataggio locale - controlla se il browser blocca storage o se sei in incognito.");
            }
        }

        function updateTasks(newTasksRaw, saveToCache = true) {
            // Merge 'done' state from existing tasks if they have the same ID
            const formatted = newTasksRaw.map(t => {
                const existing = state.tasks.find(ex => ex.id === t.id);
                return {
                    id: t.id,
                    text: t.text,
                    done: existing ? existing.done : false
                };
            });

            state.tasks = formatted;

            if (saveToCache) {
                saveTasks(); // ‚≠ê Chiama salvataggio
            }
        }

        function render() {
            // Update nav
            document.querySelectorAll('.nav-item').forEach((el, idx) => {
                const views = ['home', 'market', 'feed', 'planner', 'profile'];
                if (views[idx] === state.view) el.classList.add('active');
                else el.classList.remove('active');
            });

            if (!state.isLoggedIn) {
                document.getElementById('bottom-nav').style.display = 'none';
                app.innerHTML = renderLogin();
            } else {
                document.getElementById('bottom-nav').style.display = 'flex';
                if (state.view === 'home') app.innerHTML = renderHome();
                else if (state.view === 'search') app.innerHTML = renderSearch();
                else if (state.view === 'market') app.innerHTML = renderMarket();
                else if (state.view === 'feed') app.innerHTML = renderFeed();
                else if (state.view === 'planner') app.innerHTML = renderPlanner();
                else if (state.view === 'profile') app.innerHTML = renderProfile();
                else if (state.view === 'chat') app.innerHTML = renderChat();
            }
        }

        function navigate(v) { state.view = v; render(); }

        function logout() {
            sessionManager.clear();
            state.isLoggedIn = false;
            state.user = { name: 'Andrea', class: '5B' };
            state.tasks = [];
            state.view = 'login';
            render();
            alert('‚úÖ Disconnesso correttamente');
        }

        function renderLogin() {
            return `
            <div class="view" style="height: 100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <h1 style="margin-bottom:40px;">üìö G-Connect</h1>
                <p style="color:var(--text-secondary); margin-bottom:30px;">Accedi con le tue credenziali Argo</p>
                <button class="btn-primary" onclick="openArgoLogin()" style="max-width:300px;">Accedi</button>
            </div>`;
        }

        function renderHome() {
            return `
                <div class="view">
                    <div style="display:  flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <div style="font-size: 14px; color: var(--text-secondary); font-weight: 600;">BENTORNATO</div>
                            <h1>${state.user.name}</h1>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <div onclick="navigate('search')" style="width: 44px; height: 44px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                <i class="ph-fill ph-users" style="font-size: 20px;"></i>
                            </div>
                            <div onclick="alert('Nessuna nuova notifica')" style="width: 44px; height: 44px; background: rgba(255,255,255,0.1); border-radius: 50%; display:  flex; align-items: center; justify-content: center; cursor: pointer;">
                                <i class="ph-fill ph-bell" style="font-size: 20px;"></i>
                            </div>
                        </div>
                    </div>

                    <h2 style="margin-bottom: 16px;">La Tua Situazione</h2>
                    <div style="display: flex; gap: 16px; margin-bottom: 30px;">
                        <div class="card" style="flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 0;">
                            <span style="font-size: 32px; font-weight: 700; color: var(--green);">7. 8</span>
                            <span style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Media Voti</span>
                        </div>

                        <div class="card" onclick="navigate('planner')" style="flex: 1; padding: 16px; margin-bottom: 0; cursor: pointer;">
                            <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase;">Da fare</div>
                            <div style="font-size: 20px; font-weight: 700;">${state.tasks.length}</div>
                            <div style="font-size:  12px; color: var(--text-secondary); margin-top:4px;">compiti</div>
                        </div>
                    </div>

                    <h2 style="margin-bottom: 16px;">Ultime Circolari</h2>
                    <div style="display: flex; gap: 12px; overflow-x: auto;">
                        ${state.news.slice(0, 3).map(n => `
                            <div onclick="window.open('${n.url}', '_blank')" style="min-width: 200px; background: rgba(28,28,30,0.6); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); cursor:pointer;">
                                <div style="font-size: 12px; color: var(--red); font-weight: 600; margin-bottom: 8px;">üìÑ ${n.date}</div>
                                <div style="font-size: 14px; font-weight: 600; line-height: 1.3;">${n.title}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderMarket() {
            return `
                <div class="view">
                   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:24px;">
                        <h1>Market Libri</h1>
                        <button onclick="openNewItemModal()" style="background: var(--green); color:black; padding:8px 16px; border-radius:20px; border:none; font-weight:700; cursor:pointer;">+ Vendi</button>
                    </div> 
                    <div style="display:  grid; grid-template-columns: 1fr 1fr; gap:  16px;">
                        ${state.marketItems.map(item => `
                            <div class="card" style="padding: 0; overflow:hidden; display:flex; flex-direction:column; margin: 0;">
                                <div style="height:140px; background:#333; display:flex; align-items:center; justify-content:center;">
                                    ${item.image ? `<img src="${item.image}" style="width:100%; height:100%; object-fit:cover;">` : `<i class="ph ph-book-open" style="font-size:40px; color:rgba(255,255,255,0.2);"></i>`}
                                </div>
                                <div style="padding:12px;">
                                    <div style="font-weight:600; font-size:14px; margin-bottom:4px;">${item.title}</div>
                                    <div style="font-size:12px; color: var(--text-secondary); margin-bottom:8px;">Di ${item.seller}</div>
                                    <div style="font-weight:700; color:var(--green);">${item.price}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSearch() {
            return `
                <div class="view" style="padding-top:  0;">
                    <div class="search-container">
                         <div style="display:flex; align-items:center; gap:10px; margin:  10px 0;">
                             <button onclick="navigate('home')" style="background: none; border:none; color:white; font-size:24px; cursor:pointer;"><i class="ph ph-arrow-left"></i></button>
                             <h1 style="margin: 0;">Community</h1>
                         </div>
                        <div style="position:  relative;">
                            <i class="ph ph-magnifying-glass" style="position:  absolute; left: 14px; top: 12px; color: var(--text-secondary); font-size: 20px;"></i>
                            <input id="search-input" type="text" placeholder="Cerca studente..." oninput="filterStudents(this.value)" style="padding-left: 44px; margin-bottom: 0;">
                        </div>
                    </div>
                    <div id="student-list" style="padding-top: 10px;"></div>
                </div>
            `;
        }

        function filterStudents(q) {
            const list = document.getElementById('student-list');
            if (!list) return; // üÜï Guard check

            const filtered = DIRECTORY.filter(u => u.name.toLowerCase().includes(q.toLowerCase()));

            if (filtered.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding:  40px; color: var(--text-secondary);">Nessun utente trovato</div>`;
                return;
            }

            list.innerHTML = filtered.map(u => `
                <div onclick="openChat('${u.name}')" style="display:  flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor:pointer;">
                    <div style="position: relative; margin-right: 16px;">
                        <div style="width: 50px; height: 50px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">${u.name[0]}</div>
                        ${u.status === 'online' ? `<div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: var(--green); border:  2px solid black; border-radius: 50%;"></div>` : ''}
                    </div>
                    <div style="flex:  1;">
                        <div style="font-weight: 600;">${u.name}</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">Classe ${u.class}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderFeed() {
            let displayPosts = state.posts;

            if (state.feed.classFilter !== 'Tutte') {
                displayPosts = displayPosts.filter(p => p.class === state.feed.classFilter);
            }

            if (state.feed.search) {
                const q = state.feed.search.toLowerCase();
                displayPosts = displayPosts.filter(p =>
                    p.author.toLowerCase().includes(q) ||
                    p.text.toLowerCase().includes(q)
                );
            }

            const allClasses = ['Tutte', ... new Set(DIRECTORY.map(u => u.class))];

            return `
            <div class="view">
                <div style="display: flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h1>Feed</h1>
                    <button onclick="openNewPostModal()" style="background:var(--blue); padding:8px 16px; border-radius:20px; border: none; color:white; font-weight:600; cursor:pointer;">+ Post</button>
                </div>

                <div style="position: relative; margin-bottom: 16px;">
                     <i class="ph ph-magnifying-glass" style="position:  absolute; left: 14px; top: 12px; color:  var(--text-secondary); font-size: 20px;"></i>
                     <input type="text" placeholder="Cerca..." value="${state.feed.search}" oninput="updateFeedSearch(this.value)" style="padding-left: 44px; margin-bottom: 0;">
                </div>

                ${displayPosts.map(post => `
                    <div class="card">
                        <div style="display:flex; gap:12px; margin-bottom:12px;">
                            <div style="width: 40px; height:40px; background: var(--blue); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px;">${post.author[0]}</div>
                            <div>
                                <div style="font-weight:700;">${post.author}</div>
                                <div style="font-size:12px; opacity:0.6;">${post.class}</div>
                            </div>
                        </div>
                        <p style="margin: 0 0 12px 0;">${post.text}</p>
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top:10px; display:flex; gap:20px;">
                            <button onclick="toggleLike(${post.id})" style="background:none; border:none; color:${post.liked ? 'var(--red)' : 'var(--text-secondary)'}; cursor:pointer;"><i class="${post.liked ? 'ph-fill' : 'ph'} ph-heart"></i> ${post.likes}</button>
                        </div>
                    </div>
                `).join('')}
            </div>`;
        }

        function renderChat() {
            const msgs = state.messages[state.currentChatUser] || [];
            return `
            <div style="display:flex; flex-direction:column; height:100vh;">
                <div style="padding:20px; padding-top:60px; background:rgba(28,28,30,0.9); display:flex; align-items:center; gap:16px; border-bottom:1px solid rgba(255,255,255,0.1);">
                    <button onclick="navigate('search')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;"><i class="ph ph-arrow-left"></i></button>
                    <h2>${state.currentChatUser}</h2>
                </div>
                <div id="chat-history" style="flex: 1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:8px;">
                    ${msgs.map(m => `<div class="message-bubble ${m.me ? 'msg-me' : 'msg-other'}">${m.text}</div>`).join('')}
                </div>
                <div style="padding: 20px; background:black; display:flex; gap:10px; border-top:1px solid rgba(255,255,255,0.1);">
                    <input id="msg-input" placeholder="Messaggio..." style="margin-bottom:0; flex:1;">
                    <button onclick="sendMessage()" style="background:var(--blue); width:50px; height:50px; border-radius:50%; border:none; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="ph-fill ph-paper-plane-right"></i></button>
                </div>
            </div>`;
        }

        function renderPlanner() {
            const hasTasks = state.tasks.length > 0;

            return `
            <div class="view">
                <div style="display:  flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h1>Planner</h1>
                    ${!hasTasks ? `<button onclick="openArgoLogin()" style="background:linear-gradient(135deg, #106690 0%, #0c4b6e 100%); color:white; padding:8px 16px; border-radius:20px; border: none; font-weight:600; font-size:13px; cursor:pointer;">
                            <i class="ph-fill ph-plugs-connected"></i> Collega Argo
                        </button>` : `<button onclick="performSync()" style="background:rgba(34,197,94,0.1); border:  1px solid rgba(34,197,94,0.3); color:var(--green); padding:8px 16px; border-radius:20px; font-weight:600; cursor:pointer;">
                            <i class="ph-fill ph-check-circle"></i> Sincronizza
                        </button>`}
                </div>
                
                ${!hasTasks ? `
                    <div style="background:rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding:24px; border-radius:16px; text-align:center;">
                        <i class="ph ph-book-open" style="font-size:48px; opacity:0.3; margin-bottom:12px;"></i>
                        <p style="margin:  0; color: var(--text-secondary);">Nessun compito.  Collega Argo per iniziare.</p>
                    </div>
                ` : `
                <div>
                    ${state.tasks.map(t => `
                        <div onclick="toggleTask(${t.id})" style="background:  ${t.done ? 'rgba(255,255,255,0.05)' : 'rgba(28,28,30,0.6)'}; padding:  16px; border-radius:  12px; margin-bottom: 10px; display: flex; align-items: center; gap: 16px; cursor: pointer;">
                            <div style="width: 24px; height: 24px; border:  2px solid ${t.done ? 'var(--green)' : 'rgba(255,255,255,0.3)'}; background: ${t.done ? 'var(--green)' : 'transparent'}; border-radius: 6px; display: flex; align-items: center; justify-content:  center; flex-shrink: 0;">
                                ${t.done ? '<i class="ph-bold ph-check" style="font-size: 12px; color: black;"></i>' : ''}
                            </div>
                            <span style="font-size: 16px; text-decoration: ${t.done ? 'line-through' : 'none'}; opacity: ${t.done ? 0.5 : 1}; flex:  1;">${t.text}</span>
                        </div>
                    `).join('')}
                </div>
                `}
            </div>`;
        }

        function renderProfile() {
            return `
            <div class="view">
                <h1>Profilo</h1>
                <div style="margin-top:20px;">
                    <div class="card">
                        <div style="font-size: 14px; color:var(--text-secondary); margin-bottom:8px;">Utente Collegato</div>
                        <div style="font-size:18px; font-weight:700; margin-bottom:16px;">${state.user.name}</div>
                        <div style="font-size:14px; color:  var(--text-secondary);">Classe:  ${state.user.class}</div>
                    </div>
                    <button class="btn-primary" onclick="logout()" style="background:var(--red); margin-top:20px;">Esci e Disconnetti</button>
                </div>
            </div>`;
        }

        function openNewPostModal() {
            modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <button onclick="closeModal()" style="background:none; border:none; color:var(--blue); cursor:pointer;">Annulla</button>
                        <b>Nuovo Post</b>
                        <button onclick="publishPost()" style="background:none; border:none; color:var(--blue); font-weight:700; cursor:pointer;">Pubblica</button>
                    </div>
                    <textarea id="new-post-text" rows="5" placeholder="Scrivi qualcosa..."></textarea>
                </div>
            </div>`;
        }

        function openNewItemModal() {
            modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content">
                    <div style="display: flex; justify-content:space-between; margin-bottom:20px;">
                        <button onclick="closeModal()" style="background: none; border:none; color: var(--blue); cursor:pointer;">Annulla</button>
                        <b>Vendi Libro</b>
                        <button onclick="publishItem()" style="background:none; border:none; color:var(--green); font-weight:700; cursor:pointer;">Pubblica</button>
                    </div>
                    <input id="item-title" placeholder="Titolo Libro">
                    <input id="item-price" placeholder="Prezzo (es.  15‚Ç¨)">
                </div>
            </div>`;
        }

        function openArgoLogin() {
            modalContainer.innerHTML = `
            <div class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content" style="text-align:center;">
                    <h2 style="margin-bottom:20px;">Collega DidUP/Argo</h2>
                    <div id="server-status" style="margin-bottom:  20px; font-size:  12px; color: var(--orange); display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <span style="width: 8px; height: 8px; background: var(--orange); border-radius: 50%;"></span>
                        Checking server...
                    </div>

                    <input id="argo-school" placeholder="Codice Scuola (es. SG12345)">
                    <input id="argo-user" placeholder="Nome Utente">
                    <input type="password" id="argo-pass" placeholder="Password">
                    
                    <button id="login-btn" onclick="performArgoSync()" class="btn-primary" style="margin-top:10px;">Accedi</button>
                    <button onclick="closeModal()" style="background:none; width:100%; padding:  10px; margin-top:5px; border:none; color: var(--text-secondary); cursor:pointer;">Annulla</button>
                </div>
            </div>`;

            checkServerHealth();
        }

        async function checkServerHealth(attempt = 1) {
            const statusEl = document.getElementById('server-status');
            if (!statusEl) return;

            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 3000);

                const res = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                clearTimeout(id);

                if (res.ok) {
                    statusEl.innerHTML = `<span style="width: 8px; height: 8px; background: var(--green); border-radius: 50%;"></span> Server Online`;
                    statusEl.style.color = "var(--green)";
                } else {
                    throw new Error("Server error");
                }
            } catch (e) {
                if (attempt < 10) {
                    setTimeout(() => checkServerHealth(attempt + 1), 2000);
                } else {
                    statusEl.innerHTML = `<span style="width: 8px; height: 8px; background: var(--red); border-radius: 50%;"></span> Offline (dati cached)`;
                    statusEl.style.color = "var(--red)";
                }
            }
        }

        async function performArgoSync() {
            const btn = document.getElementById('login-btn');
            const school = document.getElementById('argo-school').value;
            const user = document.getElementById('argo-user').value;
            const pass = document.getElementById('argo-pass').value;

            if (!school || !user || !pass) {
                alert("Inserisci tutti i dati!");
                return;
            }

            btn.innerText = "Connessione... ";
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schoolCode: school, username: user, password: pass })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || "Errore Server");
                }

                if (data.success) {
                    console.log("‚úÖ Login OK, saving...");
                    if (data.session) {
                        data.session.storedUser = btoa(unescape(encodeURIComponent(user)));
                        data.session.storedPass = btoa(unescape(encodeURIComponent(pass)));
                        data.session.schoolCode = school;
                        sessionManager.save(data.session);
                    }
                    if (data.student) {
                        state.user = data.student;
                        localStorage.setItem('argo_user', JSON.stringify(state.user)); // ‚≠ê Salva user
                    }
                    if (data.tasks && data.tasks.length > 0) {
                        state.tasks = data.tasks.map(t => ({ id: t.id, text: t.text, done: false }));
                        saveTasks(); // ‚≠ê Salva dopo update
                    }

                    state.isLoggedIn = true;
                    state.isOffline = false;
                    updateOfflineBadge();

                    closeModal();
                    alert(`‚úÖ Benvenuto ${data.student.name}!`);
                    render();
                } else {
                    alert("‚ùå Credenziali errate");
                }
            } catch (e) {
                alert("‚ùå Errore:  " + e.message);
            } finally {
                btn.innerText = "Accedi";
                btn.disabled = false;
            }
        }

        function publishPost() {
            const text = document.getElementById('new-post-text').value;
            if (text) {
                state.posts.unshift({
                    id: Date.now(),
                    author: state.user.name,
                    class: state.user.class,
                    text: text,
                    likes: 0,
                    liked: false,
                    anon: false,
                    image: null,
                    comments: []
                });
                closeModal();
                render();
            }
        }

        function publishItem() {
            const title = document.getElementById('item-title').value;
            const price = document.getElementById('item-price').value;
            if (title && price) {
                state.marketItems.unshift({
                    id: Date.now(),
                    title: title,
                    price: price,
                    image: null,
                    seller: state.user.name
                });
                closeModal();
                render();
            }
        }

        function toggleLike(id) {
            const p = state.posts.find(x => x.id === id);
            if (p) {
                p.liked = !p.liked;
                p.likes += p.liked ? 1 : -1;
                render();
            }
        }

        function closeModal(e) {
            if (!e || e.target.classList.contains('modal-overlay')) {
                modalContainer.innerHTML = '';
            }
        }

        function openChat(u) {
            state.currentChatUser = u;
            if (!state.messages[u]) state.messages[u] = [];
            navigate('chat');
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const txt = input.value;
            if (txt) {
                state.messages[state.currentChatUser].push({ text: txt, me: true });
                input.value = '';
                render();
                setTimeout(() => {
                    const history = document.getElementById('chat-history');
                    if (history) history.scrollTop = history.scrollHeight;
                }, 10);
            }
        }

        function toggleTask(id) {
            const t = state.tasks.find(x => x.id === id);
            if (t) {
                t.done = !t.done;
                saveTasks(); // ‚≠ê Persisti done immediatamente
                render();
            }
        }

        function updateFeedSearch(value) {
            state.feed.search = value;
            render();
        }

        function setFeedClass(c) {
            state.feed.classFilter = c;
            render();
        }

        // Init - render will be called by DOMContentLoaded
    </script>
</body>

</html>