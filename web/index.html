<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G-Connect</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Icons & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Stili aggiuntivi per modal profili */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-content {
            background: var(--card-bg-gradient);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .profile-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .profile-card:hover {
            border-color: var(--accent-color);
            background: rgba(99, 102, 241, 0.1);
            transform: translateX(4px);
        }
        
        .profile-card:active {
            transform: scale(0.98);
        }
        
        .profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-weight: 600;
            font-size: 17px;
            margin-bottom: 4px;
        }
        
        .profile-class {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- App Container -->
    <div id="app"></div>
    
    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="hidden">
        <button class="nav-item" data-target="home">
            <i class="ph-fill ph-house"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" data-target="feed">
            <i class="ph-fill ph-newspaper"></i>
            <span>Feed</span>
        </button>
        <button class="nav-item" data-target="planner">
            <i class="ph-fill ph-calendar"></i>
            <span>Planner</span>
        </button>
        <button class="nav-item" data-target="market">
            <i class="ph-fill ph-storefront"></i>
            <span>Market</span>
        </button>
        <button class="nav-item" data-target="profile">
            <i class="ph-fill ph-user"></i>
            <span>Profilo</span>
        </button>
    </nav>

    <script>
        // ============= CONFIGURAZIONE =============
        const API_BASE_URL = 'https://your-backend-url.onrender.com'; // üëà CAMBIA QUESTO!
        
        // ============= STATE MANAGEMENT =============
        const state = {
            user: null,
            session: null,
            currentView: 'login',
            tasks: [],
            voti: [],
            promemoria: [],
            profili: [],
            sessionId: null,
            availableProfiles: [],
            selectedProfileId: null
        };

        const app = document.getElementById('app');
        const nav = document.getElementById('bottom-nav');

        // ============= STORAGE HELPERS =============
        function saveToStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error('‚ùå Storage error:', e);
            }
        }

        function loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('‚ùå Load error:', e);
                return null;
            }
        }

        // ============= API CALLS =============
        async function apiLogin(schoolCode, username, password) {
            const response = await fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ schoolCode, username, password })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Login fallito');
            }
            
            return await response.json();
        }

        async function apiSelectProfile(sessionId, profileId) {
            const response = await fetch(`${API_BASE_URL}/select-profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId, profileId })
            });

            if (!response.ok) {
                throw new Error('Selezione profilo fallita');
            }

            return await response.json();
        }

        async function apiSync(schoolCode, storedUser, storedPass, profileId) {
            const response = await fetch(`${API_BASE_URL}/sync`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    schoolCode,
                    storedUser,
                    storedPass,
                    profileId
                })
            });

            if (!response.ok) {
                throw new Error('Sincronizzazione fallita');
            }

            return await response.json();
        }

        // ============= PROFILE SELECTION MODAL =============
        function showProfileSelector(profili) {
            console.log('üìã Apertura modal selezione profilo:', profili);

            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };

            const profiloCards = profili.map(p => `
                <div class="profile-card" onclick="selectProfile('${p.id}')"
                     onmouseover="this.style.borderColor='var(--accent-color)'; this.style.transform='translateY(-2px)'"
                     onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.transform='translateY(0)'">
                    <div class="profile-avatar" style="
                        width: 50px;
                        height: 50px;
                        border-radius: 50%;
                        background: var(--accent-gradient);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 20px;
                        flex-shrink: 0;
                    ">${p.nome[0]}</div>
                    <div class="profile-info">
                        <div class="profile-name">${p.nome}</div>
                        <div class="profile-class">${p.classe || 'Classe non disponibile'} ‚Ä¢ ${p.annoScolastico || '2024/2025'}</div>
                    </div>
                    <i class="ph ph-caret-right" style="color: var(--text-secondary); font-size: 20px;"></i>
                </div>
            `).join('');

            overlay.innerHTML = `
                <div class="modal-content">
                    <h2 class="title" style="text-align: center; margin-bottom: 8px;">üë• Seleziona Profilo</h2>
                    <p class="subtitle" style="text-align: center; margin-bottom: 24px;">
                        Trovati ${profili.length} profili associati a questo account
                    </p>
                    ${profiloCards}
                    <button onclick="this.closest('.modal-overlay').remove()"
                            style="
                                width: 100%;
                                margin-top: 20px;
                                padding: 14px;
                                background: rgba(255,255,255,0.1);
                                border: none;
                                border-radius: 12px;
                                color: white;
                                font-size: 16px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                        Annulla
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        // ============= SYNC DATA FUNCTION =============
        async function syncData() {
            const session = JSON.parse(localStorage.getItem('argo_session'));
            if (!session || !session.storedUser || !session.storedPass) {
                console.warn('‚ö†Ô∏è Nessuna sessione salvata per sync');
                return;
            }

            console.log('üîÑ Sincronizzazione in background...');

            try {
                console.log('üì§ Invio richiesta sync con sessione salvata');

                const data = await apiSync(session.schoolCode, session.storedUser, session.storedPass, session.profileId);

                console.log('üì• Dati ricevuti dal server:', data);

                if (data.success) {
                    // Aggiorna tasks preservando lo stato 'done'
                    console.log('üìã Tasks ricevuti:', data.tasks);
                    if (data.tasks && Array.isArray(data.tasks)) {
                        // Merge con tasks esistenti mantenendo lo stato 'done'
                        const existingTasks = state.tasks || [];
                        const newTasks = data.tasks.map(newTask => {
                            const existing = existingTasks.find(t => t.id === newTask.id);
                            return existing ? { ...newTask, done: existing.done } : newTask;
                        });
                        state.tasks = newTasks;
                        saveToStorage('tasks', state.tasks);
                    }

                    // Aggiorna voti
                    if (data.voti !== undefined) {
                        state.voti = Array.isArray(data.voti) ? data.voti : [];
                        saveToStorage('voti', state.voti);
                        console.log('üíæ Voti salvati:', state.voti.length);
                    }

                    // Aggiorna promemoria
                    if (data.promemoria !== undefined) {
                        state.promemoria = Array.isArray(data.promemoria) ? data.promemoria : [];
                        saveToStorage('promemoria', state.promemoria);
                        console.log('üíæ Promemoria salvati:', state.promemoria.length);
                    }

                    // Aggiorna token
                    if (data.new_tokens) {
                        session.authToken = data.new_tokens.authToken;
                        session.accessToken = data.new_tokens.accessToken;
                        localStorage.setItem('argo_session', JSON.stringify(session));
                    }

                    console.log('‚úÖ Sync completato:', {
                        tasks: state.tasks.length,
                        voti: state.voti.length
                    });

                    // Rerender se necessario
                    render();
                } else {
                    console.warn('‚ö†Ô∏è Sync fallito:', data.error);
                }
            } catch (e) {
                console.error('‚ùå Errore sync:', e);
            }
        }

        window.selectProfile = async function(profileId) {
            console.log('üë§ Profilo selezionato:', profileId);

            // Trova profilo
            const profile = state.availableProfiles.find(p => p.id === profileId);
            if (!profile) {
                alert('‚ùå Profilo non trovato');
                return;
            }

            // Mostra loading
            const overlay = document.querySelector('.modal-overlay');
            const modalContent = overlay.querySelector('.modal-content');
            modalContent.innerHTML = `
                <h2 class="title" style="text-align: center;">Caricamento ${profile.nome}...</h2>
                <div class="loading-spinner"></div>
                <p style="text-align: center; color: var(--text-secondary); margin-top: 10px;">Recupero dati in corso</p>
            `;

            try {
                const data = await apiSelectProfile(state.sessionId, profileId);
                console.log('üì• Dati profilo ricevuti:', data);

                if (data.success) {
                    // Salva profileId per future sync
                    state.selectedProfileId = profileId;

                    // Aggiorna sessione localStorage con profileId
                    const session = JSON.parse(localStorage.getItem('argo_session') || '{}');
                    session.profileId = profileId;
                    localStorage.setItem('argo_session', JSON.stringify(session));

                    // Carica dati
                    state.user = data.student;
                    state.user.profileId = profileId;
                    state.session = { sessionId: state.sessionId, profileId };
                    state.tasks = data.tasks || [];
                    state.voti = data.voti || [];
                    state.promemoria = data.promemoria || [];

                    saveToStorage('user', state.user);
                    saveToStorage('session', state.session);
                    saveToStorage('tasks', state.tasks);
                    saveToStorage('voti', state.voti);
                    saveToStorage('promemoria', state.promemoria);

                    // Rimuovi modal
                    overlay.remove();

                    // Vai alla home
                    navigate('home');
                } else {
                    alert('‚ùå Errore caricamento profilo: ' + (data.error || 'Errore sconosciuto'));
                    overlay.remove();
                    navigate('login');
                }

            } catch (error) {
                console.error('‚ùå Errore selezione profilo:', error);
                alert('Errore durante la selezione del profilo: ' + error.message);
                document.querySelector('.modal-overlay')?.remove();
                navigate('login');
            }
        };

        // ============= LOGIN COMPONENT =============
        function renderLogin(onLoginSuccess) {
            const container = document.createElement('div');
            container.className = 'view';
            container.style.height = '100vh';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.justifyContent = 'center';

            // Pre-compila con dati salvati se disponibili
            const savedCreds = loadFromStorage('credentials') || {};

            container.innerHTML = `
                <h1 class="title" style="text-align: center; margin-bottom: 40px;">G-Connect</h1>
                
                <input type="text" placeholder="Codice Scuola (es. SG12345)" id="school-code" 
                       value="${savedCreds.schoolCode || ''}">
                <input type="text" placeholder="Username" id="username" 
                       value="${savedCreds.username || ''}">
                <input type="password" placeholder="Password" id="password" 
                       value="${savedCreds.password || ''}">
                
                <button class="btn-primary" id="login-btn">Accedi</button>
                
                <p style="text-align: center; color: var(--text-secondary); margin-top: 20px; font-size: 14px;">
                    Accedendo accetti i termini di servizio della scuola.
                </p>
            `;

            const btn = container.querySelector('#login-btn');
            btn.addEventListener('click', async () => {
                const schoolCode = container.querySelector('#school-code').value.trim();
                const username = container.querySelector('#username').value.trim();
                const password = container.querySelector('#password').value.trim();
                
                if (!schoolCode || !username || !password) {
                    alert('Compila tutti i campi');
                    return;
                }
                
                btn.innerHTML = '<div class="loading-spinner" style="margin: 0 auto; width: 20px; height: 20px; border-width: 2px;"></div>';
                btn.disabled = true;
                
                try {
                    console.log('üîê Tentativo login...');
                    const data = await apiLogin(schoolCode, username, password);

                    console.log('üì• Risposta backend:', data);

                    if (data.success) {
                        const credentials = { schoolCode, username, password };

                        // ============= CASO 1: MULTI-PROFILO =============
                        if (data.multiProfile && data.requiresSelection) {
                            console.log(`üë• Multi-profilo rilevato: ${data.profili.length} profili`);

                            // Salva sessione
                            state.sessionId = data.session.sessionId;
                            state.availableProfiles = data.profili;

                            // Salva anche credenziali per future sync
                            const sessionData = {
                                schoolCode: schoolCode,
                                authToken: data.session.authToken,
                                accessToken: data.session.accessToken,
                                userName: data.session.userName,
                                storedUser: btoa(unescape(encodeURIComponent(username))),
                                storedPass: btoa(unescape(encodeURIComponent(password)))
                            };
                            localStorage.setItem('argo_session', JSON.stringify(sessionData));

                            // Chiudi modal login
                            // Mostra modal selezione profilo
                            showProfileSelector(data.profili);

                            btn.innerHTML = 'Accedi';
                            btn.disabled = false;
                            return; // STOP - attendi selezione utente
                        }

                        // ============= CASO 2: PROFILO SINGOLO =============
                        console.log('üë§ Profilo singolo');
                        state.user = data.student;
                        state.session = data.session;
                        state.tasks = data.tasks || [];
                        state.voti = data.voti || [];
                        state.promemoria = data.promemoria || [];

                        saveToStorage('user', state.user);
                        saveToStorage('session', state.session);
                        saveToStorage('credentials', credentials);
                        saveToStorage('tasks', state.tasks);
                        saveToStorage('voti', state.voti);
                        saveToStorage('promemoria', state.promemoria);

                        navigate('home');
                    }
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    alert('Errore di login: ' + error.message);
                    btn.innerHTML = 'Accedi';
                    btn.disabled = false;
                }
            });

            return container;
        }

        // ============= DASHBOARD COMPONENT =============
        function renderDashboard(user) {
            const container = document.createElement('div');
            container.className = 'view';

            const prossimeScadenze = state.tasks
                .filter(t => !t.done)
                .slice(0, 3);

            const ultimiVoti = state.voti
                .slice(-3)
                .reverse();

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <div class="subtitle" style="margin-bottom: 4px;">Benvenuto,</div>
                        <div class="title">${user.name || 'Studente'}</div>
                    </div>
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--accent-gradient); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;">
                        ${(user.name || 'S')[0]}
                    </div>
                </div>

                ${prossimeScadenze.length > 0 ? `
                    <div class="header">Prossime Scadenze</div>
                    ${prossimeScadenze.map(task => `
                        <div class="card" style="margin-bottom: 12px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${task.text || task.desCompito}</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                <i class="ph ph-book"></i> ${task.subject || task.materia} ‚Ä¢ 
                                <i class="ph ph-calendar"></i> ${task.due_date || task.datCompito || task.date}
                            </div>
                        </div>
                    `).join('')}
                ` : `
                    <div class="card">
                        <p style="text-align: center; color: var(--text-secondary);">
                            üìö Nessun compito in sospeso
                        </p>
                    </div>
                `}

                ${ultimiVoti.length > 0 ? `
                    <div class="header" style="margin-top: 24px;">Ultimi Voti</div>
                    ${ultimiVoti.map(voto => `
                        <div class="card" style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${voto.materia || voto.subject}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">
                                    ${voto.data || voto.date || 'Data non disponibile'}
                                </div>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: var(--accent-color);">
                                ${voto.valore || voto.value}
                            </div>
                        </div>
                    `).join('')}
                ` : `
                    <div class="header" style="margin-top: 24px;">Voti</div>
                    <div class="card">
                        <p style="text-align: center; color: var(--text-secondary);">
                            üìä Nessun voto disponibile
                        </p>
                    </div>
                `}

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 24px;">
                    ${renderActionCard('ph-chart-bar', 'Tutti i Voti', 'var(--success)', () => showAllVoti())}
                    ${renderActionCard('ph-list-bullets', 'Compiti', 'var(--info)', () => navigate('planner'))}
                </div>
            `;

            return container;
        }

        function renderActionCard(icon, title, color, action) {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; margin-bottom: 0; cursor: pointer; transition: transform 0.1s;';
            card.innerHTML = `
                <i class="ph-fill ${icon}" style="font-size: 28px; color: ${color}; margin-bottom: 8px;"></i>
                <span style="font-weight: 600; font-size: 15px;">${title}</span>
            `;
            card.onclick = action;
            return card.outerHTML;
        }

        window.showAllVoti = function() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };

            const votiHtml = state.voti.length > 0 
                ? state.voti.map(v => `
                    <div class="card" style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">${v.materia || v.subject}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                ${v.tipo || v.type || 'Voto'} ‚Ä¢ ${v.data || v.date}
                            </div>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--accent-color);">
                            ${v.valore || v.value}
                        </div>
                    </div>
                `).join('')
                : '<p style="text-align: center; color: var(--text-secondary);">Nessun voto disponibile</p>';

            overlay.innerHTML = `
                <div class="modal-content">
                    <h2 class="title" style="margin-bottom: 20px;">Tutti i Voti</h2>
                    ${votiHtml}
                    <button class="btn-primary" onclick="this.closest('.modal-overlay').remove()">Chiudi</button>
                </div>
            `;

            document.body.appendChild(overlay);
        };

        // ============= ALTRE VIEWS (SEMPLIFICATO) =============
        function renderFeed() {
            const container = document.createElement('div');
            container.className = 'view';
            container.innerHTML = `
                <div class="header">Community Feed</div>
                <div class="card">
                    <p style="text-align: center; color: var(--text-secondary);">
                        üöß Sezione in sviluppo
                    </p>
                </div>
            `;
            return container;
        }

        function renderPlanner() {
            const container = document.createElement('div');
            container.className = 'view';
            
            const tasksHtml = state.tasks.length > 0
                ? state.tasks.map(task => `
                    <div class="card" style="margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${task.text || task.desCompito}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            <i class="ph ph-book"></i> ${task.subject || task.materia} ‚Ä¢ 
                            <i class="ph ph-calendar"></i> ${task.due_date || task.datCompito || task.date}
                        </div>
                    </div>
                `).join('')
                : '<div class="card"><p style="text-align: center; color: var(--text-secondary);">Nessun compito</p></div>';
            
            container.innerHTML = `
                <div class="header">Planner</div>
                ${tasksHtml}
            `;
            return container;
        }

        function renderMarket() {
            const container = document.createElement('div');
            container.className = 'view';
            container.innerHTML = `
                <div class="header">Mercatino</div>
                <div class="card">
                    <p style="text-align: center; color: var(--text-secondary);">
                        üõí Sezione in sviluppo
                    </p>
                </div>
            `;
            return container;
        }

        function renderProfile() {
            const container = document.createElement('div');
            container.className = 'view';
            container.innerHTML = `
                <h1 class="title">Profilo</h1>
                <div class="card">
                    <div style="margin-bottom: 16px;">
                        <strong>Nome:</strong> ${state.user?.name || 'N/D'}
                    </div>
                    <div style="margin-bottom: 16px;">
                        <strong>Compiti:</strong> ${state.tasks.length}
                    </div>
                    <div style="margin-bottom: 16px;">
                        <strong>Voti:</strong> ${state.voti.length}
                    </div>
                </div>
                <button class="btn-primary" style="margin-top: 20px; margin-bottom: 10px;" onclick="syncData()">
                    üîÑ Sincronizza Dati
                </button>
                <button class="btn-primary" style="background: var(--danger); margin-top: 10px;" id="logout-btn">
                    Logout
                </button>
            `;

            setTimeout(() => {
                container.querySelector('#logout-btn').onclick = () => {
                    if (confirm('Vuoi disconnetterti?')) {
                        localStorage.clear();
                        state.user = null;
                        state.session = null;
                        navigate('login');
                    }
                };
            }, 0);

            return container;
        }

        // ============= ROUTER =============
        function navigate(view) {
            state.currentView = view;
            render();
            updateNav();
        }

        function render() {
            app.innerHTML = '';

            if (!state.user && state.currentView !== 'login') {
                state.currentView = 'login';
            }

            switch (state.currentView) {
                case 'login':
                    nav.classList.add('hidden');
                    app.appendChild(renderLogin());
                    break;
                case 'home':
                    nav.classList.remove('hidden');
                    app.appendChild(renderDashboard(state.user));
                    break;
                case 'feed':
                    nav.classList.remove('hidden');
                    app.appendChild(renderFeed());
                    break;
                case 'planner':
                    nav.classList.remove('hidden');
                    app.appendChild(renderPlanner());
                    break;
                case 'market':
                    nav.classList.remove('hidden');
                    app.appendChild(renderMarket());
                    break;
                case 'profile':
                    nav.classList.remove('hidden');
                    app.appendChild(renderProfile());
                    break;
            }
        }

        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('.nav-item');
                if (targetBtn) {
                    navigate(targetBtn.dataset.target);
                }
            });
        });

        function updateNav() {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === state.currentView);
            });
        }

        // ============= INIT =============
        function init() {
            console.log('üöÄ App Loading...');
            
            // Carica dati salvati
            const savedUser = loadFromStorage('user');
            const savedSession = loadFromStorage('session');
            const savedTasks = loadFromStorage('tasks');
            const savedVoti = loadFromStorage('voti');
            const savedPromemoria = loadFromStorage('promemoria');
            
            if (savedUser && savedSession) {
                console.log('‚úÖ Sessione salvata trovata');
                state.user = savedUser;
                state.session = savedSession;
                state.tasks = savedTasks || [];
                state.voti = savedVoti || [];
                state.promemoria = savedPromemoria || [];
                navigate('home');
            } else {
                console.log('‚ÑπÔ∏è Nessuna sessione salvata');
                navigate('login');
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('‚úÖ Service Worker registered'))
                .catch(err => console.error('‚ùå SW registration failed:', err));
        }

        // Start App
        init();
    </script>
</body>
</html>
